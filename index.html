<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scripture Study</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jasondavies/d3-cloud@1.2.7/build/d3.layout.cloud.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- Added Marked.js -->

    <style>
        /* Styles from previous version remain largely the same */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f8fafc;
            /* slate-50 */
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 1rem;
        }

        .highlight {
            background-color: #fef9c3;
            /* yellow-100 */
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }

        /* Search Area - Advanced Options Collapse/Expand */
        .advanced-search-collapsible {
            overflow: hidden;
            transition:
                max-height 0.5s ease-out, opacity 0.3s ease-out,
                padding 0.5s ease-out, margin 0.5s ease-out;
            max-height: 1000px;
            opacity: 1;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-top: 1rem;
            background-color: white;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .advanced-search-collapsible.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0 !important;
            border-width: 0;
            box-shadow: none;
        }

        #toggleAdvancedSearchLink {
            display: none;
            margin-top: 0.5rem;
            text-align: center;
        }

        #toggleAdvancedSearchLink button {
            color: #3b82f6;
            background: none;
            border: none;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            text-decoration: underline;
        }

        #toggleAdvancedSearchLink button:hover {
            color: #2563eb;
        }

        /* Column layout styles */
        .results-flex-container {
            display: flex;
            overflow-x: auto;
            padding-bottom: 1rem;
            gap: 1rem;
        }

        .volume-column {
            flex: 0 0 auto;
            width: 320px;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            min-height: 100px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .volume-column-header-area {
            position: sticky;
            top: 0;
            background-color: #ffffff;
            z-index: 10;
            padding: 1rem 1rem 0 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .volume-column-header {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .volume-column-subheader {
            font-size: 0.875rem;
            color: #6b7280;
            padding-bottom: 0.75rem;
        }

        .volume-column-content {
            padding: 1rem;
        }

        .volume-column .result-card {
            background-color: #f9fafb;
            margin-bottom: 0.75rem;
            box-shadow: none;
            border: 1px solid #f3f4f6;
            position: relative;
            z-index: 1;
        }

        /* Grid layout styles */
        .results-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .result-card {
            background-color: white;
            /* Set consistent, minimal padding on all sides */
            padding-top: 0.05rem;
            padding-right: 0.05rem;
            padding-bottom: 0.05rem;
            /* Significantly reduced from 2.5rem */
            padding-left: 0.05rem;

            border-radius: 0.75rem;
            /* Affects corner rounding, not content space directly */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            /* Visual effect */
            border: 1px solid #e2e8f0;
            /* The border itself is 1px */

            /* Layout for direct children of .result-card */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            /* This will space out items if there are multiple direct children */
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Clickable scripture heading in result card (for main results) */
        .result-card .scripture-title-heading.clickable-heading {
            cursor: pointer;
            transition: color 0.2s;
        }

        .result-card .scripture-title-heading.clickable-heading:hover {
            color: #2563eb;
            /* blue-600 */
            text-decoration: underline;
        }


        /* Copy button */
        .copy-button:hover {
            background-color: #d1d5db;
            color: #1f2937;
        }

        .copy-button.copied {
            background-color: #10b981;
            color: white;
        }

        /* Note button */
        #noteTextarea {
            width: 95%;
            /* Take up most of the modal width */
            height: 100px;
            /* Adjust as needed */
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
            /* Allow vertical resizing */
        }

        #saveNoteButton,
        #cancelNoteButton {
            padding: 10px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #saveNoteButton {
            background-color: #4CAF50;
            /* Green */
            color: white;
        }

        #cancelNoteButton {
            background-color: #f44336;
            /* Red */
            color: white;
        }

        /* Scrollbar styles */
        .results-flex-container::-webkit-scrollbar,
        .volume-column::-webkit-scrollbar,
        .modal-box::-webkit-scrollbar,
        #contextDrawerContent::-webkit-scrollbar,
        #journalEditor::-webkit-scrollbar,
        #journalPreview::-webkit-scrollbar {
            width: 8px;
            height: 10px;
        }

        .results-flex-container::-webkit-scrollbar-track,
        .volume-column::-webkit-scrollbar-track,
        .modal-box::-webkit-scrollbar-track,
        #contextDrawerContent::-webkit-scrollbar-track,
        #journalEditor::-webkit-scrollbar-track,
        #journalPreview::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .results-flex-container::-webkit-scrollbar-thumb,
        .volume-column::-webkit-scrollbar-thumb,
        .modal-box::-webkit-scrollbar-thumb,
        #contextDrawerContent::-webkit-scrollbar-thumb,
        #journalEditor::-webkit-scrollbar-thumb,
        #journalPreview::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 10px;
        }

        .results-flex-container::-webkit-scrollbar-thumb:hover,
        .volume-column::-webkit-scrollbar-thumb:hover,
        .modal-box::-webkit-scrollbar-thumb:hover,
        #contextDrawerContent::-webkit-scrollbar-thumb:hover,
        #journalEditor::-webkit-scrollbar-thumb:hover,
        #journalPreview::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* Error message styles */
        .input-error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .input-error-message:empty {
            display: none;
        }

        /* Modal styles (Shared by Help, Stats Explanation, and Context Drawer) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 600px;
            max-height: 80vh;
            /* Modal itself is scrollable */
            overflow-y: auto;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-box {
            transform: scale(1);
        }

        .modal-close-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-close-button:hover {
            color: #1f2937;
        }

        .modal-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .modal-content h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: #4338ca;
            border-top: 1px solid #eee;
            padding-top: 1rem;
        }

        .modal-content p,
        .modal-content ul,
        .modal-content dl {
            margin-bottom: 1rem;
            color: #374151;
        }

        .modal-content li {
            margin-left: 1.5rem;
            list-style: disc;
            margin-bottom: 0.5rem;
        }

        .modal-content code {
            background-color: #f3f4f6;
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9em;
        }

        .modal-content dt {
            font-weight: 600;
            color: #1f2937;
            margin-top: 0.5rem;
        }

        .modal-content dd {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.95em;
        }

        .stop-words-list {
            column-count: 3;
            column-gap: 1rem;
            list-style: none;
            padding-left: 0;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: #f9fafb;
        }

        .stop-words-list::-webkit-scrollbar {
            width: 6px;
        }

        .stop-words-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .stop-words-list::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 10px;
        }

        .stop-words-list::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        .stop-words-list li {
            margin-bottom: 0.25rem;
            color: #4b5563;
            -webkit-column-break-inside: avoid;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        /* Context Drawer Specific Styles */
        .context-drawer-box {
            width: 700px;
            /* Wider for context view */
            max-width: 95%;
        }

        #contextDrawerContent {
            max-height: calc(80vh - 100px);
            /* Adjust based on title and padding */
            overflow-y: auto;
            padding-right: 1rem;
            /* Space for scrollbar */
            /* space-y-2 is applied via Tailwind in HTML, handles spacing between cards */
        }

        /* Styles for the highlighted current verse in the context drawer */
        #contextDrawerContent .result-card.current-context-verse {
            background-color: #e0e7ff;
            /* indigo-100 */
            border-color: #a5b4fc;
            /* indigo-300 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06), 0 0 0 2px #c7d2fe;
            /* Original shadow + indigo-200 focus ring like */
        }


        /* Search status style */
        #searchStatus {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        #searchStatus:empty {
            display: none;
        }

        /* Style for fallback data message */
        #fallbackMessage {
            font-size: 0.875rem;
            color: #ca8a04;
            background-color: #fef9c3;
            border: 1px solid #fde68a;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            text-align: center;
            max-width: 4xl;
            margin-left: auto;
            margin-right: auto;
        }

        #fallbackMessage:empty {
            display: none;
        }


        /* Main Tab styles (Scriptures/Statistics) */
        .tab-container {
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: color 0.2s, border-color 0.2s;
        }

        .tab-button:hover {
            color: #1f2937;
        }

        .tab-button.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-button:disabled {
            color: #d1d5db;
            cursor: not-allowed;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* N-gram Tab styles (within Statistics) */
        .ngram-tab-container {
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
            margin-top: 1rem;
        }

        .ngram-tab-button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: color 0.2s, border-color 0.2s;
        }

        .ngram-tab-button:hover {
            color: #1f2937;
        }

        .ngram-tab-button.active {
            color: #1f2937;
            border-bottom-color: #1f2937;
        }

        .ngram-tab-content {
            display: none;
            margin-top: 1rem;
        }

        .ngram-tab-content.active {
            display: block;
        }

        /* Stats table styles */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        .stats-table th,
        .stats-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem 0.75rem;
            text-align: left;
            vertical-align: top;
        }

        .stats-table th {
            background-color: #f9fafb;
            font-weight: 600;
            cursor: pointer;
            position: relative;
        }

        .stats-table th .sort-arrow {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7em;
            color: #9ca3af;
        }

        .stats-table th.sorted-asc .sort-arrow::after {
            content: " ▲";
            color: #374151;
        }

        .stats-table th.sorted-desc .sort-arrow::after {
            content: " ▼";
            color: #374151;
        }

        .stats-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        /* Volume Breakdown Chart Style */
        #statsVolumeChartContainer {
            width: 100%;
            min-height: 200px;
            margin-bottom: 1rem;
            position: relative;
        }

        #statsVolumeChartContainer svg {
            display: block;
            width: 100%;
            height: auto;
        }

        #statsVolumeChartContainer .axis path,
        #statsVolumeChartContainer .axis line {
            fill: none;
            stroke: #9ca3af;
            shape-rendering: crispEdges;
        }

        #statsVolumeChartContainer .axis text {
            font-size: 0.75rem;
            fill: #4b5563;
        }

        #statsVolumeChartContainer .bar {
            fill: #60a5fa;
            transition: fill 0.2s ease-in-out;
        }

        #statsVolumeChartContainer .bar:hover {
            fill: #3b82f6;
        }

        #statsVolumeChartContainer .bar-label {
            fill: #1f2937;
            font-size: 0.75rem;
            text-anchor: start;
            dominant-baseline: central;
        }

        /* Word Forms Breakdown Style */
        #statsWordFormsContainer {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        #statsWordFormsContainer h5 {
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.25rem;
            font-size: 0.9em;
        }

        #statsWordFormsContainer ul {
            list-style: none;
            padding-left: 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.5rem;
            background-color: #f9fafb;
        }

        #statsWordFormsContainer li {
            display: flex;
            justify-content: space-between;
            padding: 0.1rem 0;
            font-size: 0.9em;
            color: #374151;
        }

        #statsWordFormsContainer li span:first-child {
            margin-right: 0.5rem;
            word-break: break-all;
        }

        #statsWordFormsContainer li span:last-child {
            font-weight: 500;
            color: #1f2937;
            white-space: nowrap;
        }

        #statsWordFormsContainer .word-form-list::-webkit-scrollbar {
            width: 5px;
        }

        #statsWordFormsContainer .word-form-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        #statsWordFormsContainer .word-form-list::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 10px;
        }

        #statsWordFormsContainer .word-form-list::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        #statsWordFormsContainer p.no-forms {
            font-style: italic;
            color: #6b7280;
            font-size: 0.9em;
            margin-top: 0.25rem;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #f9fafb;
            text-align: center;
        }

        /* Word Cloud Style */
        .wordCloudContainer {
            width: 100%;
            min-height: 250px;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            position: relative;
            background-color: #f9fafb;
            margin-top: 1rem;
        }

        .wordCloudContainer svg {
            display: block;
            margin: auto;
        }

        .word-cloud-word {
            font-family: sans-serif;
            cursor: pointer;
            transition: fill 0.2s;
        }

        .word-cloud-word:hover {
            fill: #3b82f6;
        }

        .info-icon {
            display: inline-block;
            width: 0.8em;
            height: 0.8em;
            line-height: 0.8em;
            text-align: center;
            border-radius: 50%;
            background-color: #9ca3af;
            color: white;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 4px;
            cursor: help;
            vertical-align: middle;
            position: relative;
            top: -1px;
        }

        /* Journal Styles */
        #journalEditor {
            min-height: 300px;
            resize: vertical;
            max-height: 60vh;
            /* Or some other suitable max height */
            overflow-y: auto;
        }

        #journalPreview {
            min-height: 300px;
            max-height: 60vh;
            /* Or some other suitable max height */
            overflow-y: auto;
            background-color: #f9fafb;
            /* bg-gray-50 */
            padding: 1rem;
            border-radius: 0.375rem;
            /* rounded-md */
            border: 1px solid #e5e7eb;
            /* border-gray-200 */
        }

        /* Basic Markdown styling for preview if Tailwind prose is not available/used */
        #journalPreview h1,
        #journalPreview h2,
        #journalPreview h3,
        #journalPreview h4,
        #journalPreview h5,
        #journalPreview h6 {
            margin-top: 1.2em;
            margin-bottom: 0.6em;
            font-weight: 600;
            line-height: 1.25;
            color: #1f2937;
        }

        #journalPreview h1 {
            font-size: 1.875rem;
        }

        /* text-2xl */
        #journalPreview h2 {
            font-size: 1.5rem;
        }

        /* text-xl */
        #journalPreview h3 {
            font-size: 1.25rem;
        }

        /* text-lg */
        #journalPreview p {
            margin-bottom: 1em;
            line-height: 1.6;
            color: #374151;
        }

        #journalPreview ul,
        #journalPreview ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
            padding-left: 1.5em;
        }

        #journalPreview ul {
            list-style-type: disc;
        }

        #journalPreview ol {
            list-style-type: decimal;
        }

        #journalPreview li {
            margin-bottom: 0.5em;
        }

        #journalPreview blockquote {
            border-left: 4px solid #d1d5db;
            padding-left: 1em;
            margin-left: 0;
            margin-bottom: 1em;
            font-style: italic;
            color: #4b5563;
        }

        #journalPreview code {
            background-color: #e5e7eb;
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9em;
            color: #1f2937;
        }

        #journalPreview pre {
            background-color: #e5e7eb;
            padding: 1em;
            border-radius: 0.375rem;
            overflow-x: auto;
            margin-bottom: 1em;
        }

        #journalPreview pre code {
            background-color: transparent;
            padding: 0;
            font-size: 0.875em;
        }

        #journalPreview hr {
            border: 0;
            border-top: 1px solid #e5e7eb;
            margin: 2em 0;
        }

        #journalPreview a {
            color: #3b82f6;
            text-decoration: underline;
        }

        #journalPreview a:hover {
            color: #2563eb;
        }
    </style>
</head>

<body>
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-4 text-gray-800">
            Scripture Study
        </h1>
        <p class="text-center">Search, find, journal, write, repeat.</p>
        <div id="loadingIndicator" class="hidden text-center py-8 max-w-4xl mx-auto border border-gray-300 rounded-lg">
            <p class="mt-2 text-gray-600">Loading 40,000 scriptures for faster search! Thanks for waiting ~5 seconds...
            </p>
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-600"></div>
        </div>
        <div class="flex justify-center mb-4 space-x-4">
            <button id="howToSearchButton" title="How to Search"
                class="inline-flex items-center p-2 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <span>💡 How do I use this?</span>
            </button>
            <button id="toggleAdvancedSearchButton" title="Toggle Advanced Options & Filters"
                class="inline-flex items-center p-2 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-5 h-5 mr-1 toggle-icon-collapse">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-5 h-5 mr-1 toggle-icon-expand hidden">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
                </svg>
                <span id="toggleAdvancedSearchButtonText">Hide Advanced</span>
            </button>
        </div>

        <div id="searchSection" class="mb-8 max-w-4xl mx-auto">
            <div class="flex gap-2 items-start">
                <div class="flex-grow">
                    <label for="searchInput" class="sr-only">Search Text</label>
                    <input type="text" id="searchInput" placeholder="Enter phrase, keywords (AND/OR), or regex..."
                        class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg bg-white placeholder-gray-400" />
                    <div id="searchInputError" class="input-error-message"></div>
                </div>
                <button id="searchButton"
                    class="px-6 py-4 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors whitespace-nowrap">seek,</button>
            </div>
            <div id="toggleAdvancedSearchLink"><button id="showAdvancedOptionsButton">Show Advanced Options &
                    Filters</button></div>
            <div id="advancedSearchArea" class="advanced-search-collapsible">
                <div class="flex-grow space-y-4">
                    <h3 class='text-lg font-semibold mb-3 text-gray-700 text-center'>Filters & View Options</h3>
                </div>
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-grow space-y-4">
                        <h4 class="text-lg font-semibold mb-4 text-gray-700">Filters</h4>
                        <div>
                            <label for="verseTitleFilterInput"
                                class="block text-sm font-medium text-gray-700 mb-1">Filter by Verse Title
                                (Regex)</label>
                            <input type="text" id="verseTitleFilterInput" placeholder="e.g., ^John 3:1[6-7]$ or Alma 5"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                            <div id="verseTitleFilterError" class="input-error-message"></div>
                        </div>
                        <div class="border-t pt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Volume</label>
                            <div class="flex items-center mb-2"><input type="checkbox" id="allVolumesCheckbox"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-2"
                                    checked /><label for="allVolumesCheckbox"
                                    class="text-sm font-medium text-gray-900 cursor-pointer">All Volumes</label>
                            </div>
                            <div id="volumeCheckboxes"
                                class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-2"></div>
                        </div>
                    </div>
                    <div class="md:w-1/3 border border-gray-200 p-4 rounded-lg bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Advanced Options</h4>
                        <div class="space-y-3">
                            <div class="flex gap-2 items-center"><input type="checkbox" id="regexSearch"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" /><label
                                    for="regexSearch" class="text-sm text-gray-700 cursor-pointer">Search using
                                    regex</label></div>
                            <div class="flex gap-2 items-center"><input type="checkbox" id="caseSensitive"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" /><label
                                    for="caseSensitive" class="text-sm text-gray-700 cursor-pointer">Case
                                    Sensitive</label></div>
                            <div class="flex gap-2 items-center"><input type="checkbox" id="columnsByVolume"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" /><label
                                    for="columnsByVolume" class="text-sm text-gray-700 cursor-pointer">Show
                                    Volume
                                    Columns</label></div>
                            <div class="flex gap-2 items-center"><input type="checkbox" id="shuffleResults"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" /><label
                                    for="shuffleResults" class="text-sm text-gray-700 cursor-pointer">Shuffle
                                    Results</label></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fallbackMessage"></div>

        <div class="mb-4 max-w-4xl mx-auto">
            <div class="flex justify-between items-center">
                <h2 id="resultsHeading" class="text-xl font-semibold text-gray-800"><span
                        id="resultsHeadingText">Results</span></h2>
            </div>
            <p id="searchStatus" class="text-sm text-gray-500 mt-1"></p>
        </div>

        <div class="tab-container max-w-4xl mx-auto">
            <button id="scripturesTabButton" class="tab-button active" data-tab="scriptures">Scriptures (<span
                    id="scripturesTabCount">0</span>)</button>
            <button id="statsTabButton" class="tab-button" data-tab="statistics" disabled>Statistics</button>
        </div>

        <div class="tab-content-container max-w-full mx-auto">
            <div id="scripturesContent" class="tab-content active">
                <div id="noResults" class="hidden bg-gray-50 p-8 rounded-lg text-center max-w-4xl mx-auto">
                    <p class="text-gray-600"></p>
                </div>
                <div id="resultsContainer"></div>
            </div>

            <div id="statisticsContent" class="tab-content">
                <div id="statsDisplayArea" class="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">Search Statistics</h3>
                        <button id="explainStatsButton"
                            class="text-sm text-blue-600 hover:text-blue-800 underline focus:outline-none">
                            <span class="info-icon mr-1">i</span>Explain Statistics
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mb-6">
                        <div>
                            <div id="statsSummary" class="mb-4 space-y-1">
                                <p><strong>Total Unique Scriptures Matched:</strong> <span id="statsTotalCount">0</span>
                                </p>
                            </div>
                            <div id="statsWordFormsContainer">
                                <h5 class="text-sm font-semibold mb-1 text-gray-600">Word Forms Breakdown:</h5>
                                <p class="no-forms text-xs text-gray-500 italic">Perform a non-regex,
                                    single-word search
                                    to see breakdown.</p>
                                <ul class="word-form-list"></ul>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-md font-semibold mb-2 text-gray-600">Matches per Volume:</h4>
                            <div id="statsVolumeChartContainer">
                                <p class="text-xs text-gray-500 italic text-center pt-4">Perform a search to
                                    generate
                                    volume chart.</p>
                            </div>
                        </div>
                    </div>

                    <div id="statsNgramSection">
                        <h4 class="text-md font-semibold mb-2 text-gray-600 border-t pt-4">N-gram Analysis (Top
                            100)
                        </h4>
                        <p class="text-xs text-gray-500 mb-2">Analyze common words or phrases. Click headers to
                            sort
                            table.</p>
                        <div class="flex items-center space-x-4 mb-2 text-sm">
                            <div class="flex items-center">
                                <input type="checkbox" id="excludeStopWordsCheckbox"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-1"
                                    checked />
                                <label for="excludeStopWordsCheckbox" class="text-gray-700 cursor-pointer">Exclude Stop
                                    Words</label>
                            </div>
                            <button id="showStopWordsButton"
                                class="text-blue-600 hover:text-blue-800 underline text-xs focus:outline-none">
                                Show Stop Words
                            </button>
                        </div>
                        <div id="ngramTabContainer" class="ngram-tab-container">
                            <button class="ngram-tab-button active" data-ngram-tab="1gram">1-gram
                                (Words)</button>
                            <button class="ngram-tab-button" data-ngram-tab="2gram">2-gram (Pairs)</button>
                            <button class="ngram-tab-button" data-ngram-tab="3gram">3-gram (Triplets)</button>
                            <button class="ngram-tab-button" data-ngram-tab="4gram">4-gram (Quartets)</button>
                        </div>
                        <div id="ngramTabContentContainer">
                            <div id="1gramContent" class="ngram-tab-content active">
                                <div class="mb-4">
                                    <h5 class="text-sm font-semibold mb-1 text-gray-600">Word Cloud</h5>
                                    <div id="wordCloudContainer1gram" class="wordCloudContainer">
                                        <p class="wordCloudStatus text-center text-gray-500 p-4">Perform a
                                            search to
                                            generate word cloud.</p>
                                    </div>
                                </div>
                                <h5 class="text-sm font-semibold mb-1 text-gray-600">Frequency Table</h5>
                                <div class="overflow-x-auto">
                                    <table id="statsWordTable" class="stats-table">
                                        <thead>
                                            <tr>
                                                <th data-sort="word">Word <span class="sort-arrow"></span></th>
                                                <th data-sort="total">Total Count <span class="sort-arrow"></span></th>
                                                <th data-sort="unique">Unique Count <span class="sort-arrow"></span>
                                                </th>
                                                <th data-sort="freqPerScripture">Freq/Scripture <span
                                                        class="sort-arrow"></span></th>
                                                <th data-sort="freqPerWord">Freq/Word <span class="sort-arrow"></span>
                                                </th>
                                                <th data-sort="coverage">Coverage <span class="sort-arrow"></span></th>
                                            </tr>
                                        </thead>
                                        <tbody id="statsWordTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center text-gray-500 py-4">Perform a
                                                    search
                                                    to see statistics.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="2gramContent" class="ngram-tab-content">
                                <div class="mb-4">
                                    <h5 class="text-sm font-semibold mb-1 text-gray-600">Phrase Cloud</h5>
                                    <div id="wordCloudContainer2gram" class="wordCloudContainer">
                                        <p class="wordCloudStatus text-center text-gray-500 p-4">Perform a
                                            search to
                                            generate phrase cloud.</p>
                                    </div>
                                </div>
                                <h5 class="text-sm font-semibold mb-1 text-gray-600">Frequency Table</h5>
                                <div class="overflow-x-auto">
                                    <table id="statsBigramTable" class="stats-table">
                                        <thead>
                                            <tr>
                                                <th data-sort="phrase">Phrase (2-gram) <span class="sort-arrow"></span>
                                                </th>
                                                <th data-sort="total">Total Count <span class="sort-arrow"></span></th>
                                                <th data-sort="unique">Unique Count <span class="sort-arrow"></span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="statsBigramTableBody">
                                            <tr>
                                                <td colspan="3" class="text-center text-gray-500 py-4">Perform a
                                                    search
                                                    to see 2-gram statistics.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="3gramContent" class="ngram-tab-content">
                                <div class="mb-4">
                                    <h5 class="text-sm font-semibold mb-1 text-gray-600">Triplet Cloud</h5>
                                    <div id="wordCloudContainer3gram" class="wordCloudContainer">
                                        <p class="wordCloudStatus text-center text-gray-500 p-4">Perform a
                                            search to
                                            generate triplet cloud.</p>
                                    </div>
                                </div>
                                <h5 class="text-sm font-semibold mb-1 text-gray-600">Frequency Table</h5>
                                <div class="overflow-x-auto">
                                    <table id="statsTrigramTable" class="stats-table">
                                        <thead>
                                            <tr>
                                                <th data-sort="phrase">Triplet (3-gram) <span class="sort-arrow"></span>
                                                </th>
                                                <th data-sort="total">Total Count <span class="sort-arrow"></span></th>
                                                <th data-sort="unique">Unique Count <span class="sort-arrow"></span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="statsTrigramTableBody">
                                            <tr>
                                                <td colspan="3" class="text-center text-gray-500 py-4">Perform a
                                                    search
                                                    to see 3-gram statistics.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="4gramContent" class="ngram-tab-content">
                                <div class="mb-4">
                                    <h5 class="text-sm font-semibold mb-1 text-gray-600">Quartet Cloud</h5>
                                    <div id="wordCloudContainer4gram" class="wordCloudContainer">
                                        <p class="wordCloudStatus text-center text-gray-500 p-4">Perform a
                                            search to
                                            generate quartet cloud.</p>
                                    </div>
                                </div>
                                <h5 class="text-sm font-semibold mb-1 text-gray-600">Frequency Table</h5>
                                <div class="overflow-x-auto">
                                    <table id="statsQuatgramTable" class="stats-table">
                                        <thead>
                                            <tr>
                                                <th data-sort="phrase">Quartet (4-gram) <span class="sort-arrow"></span>
                                                </th>
                                                <th data-sort="total">Total Count <span class="sort-arrow"></span></th>
                                                <th data-sort="unique">Unique Count <span class="sort-arrow"></span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="statsQuatgramTableBody">
                                            <tr>
                                                <td colspan="3" class="text-center text-gray-500 py-4">Perform a
                                                    search
                                                    to see 4-gram statistics.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="statsError" class="text-red-600 text-sm mt-4 hidden"></div>
                </div>
            </div>
        </div>

        <!-- Floating Note Button -->
        <button id="journalButton"
            class="fixed bottom-4 right-4 bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform hover:scale-110 z-50">
            <svg id="penIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
            </svg>
            </svg>
        </button>

        <!-- Journal Chat Panel -->
        <div id="journalSection"
            class="fixed bottom-0 right-0 w-full md:w-1/2 h-[70vh] bg-white shadow-lg rounded-t-lg transform translate-y-full transition-transform duration-300 ease-in-out z-40 overflow-hidden">
            <div class="flex flex-col h-full overflow-hidden">
                <div class="flex justify-between items-center px-4 py-3 border-b">
                    <div class="flex items-center space-x-4">
                        <h2 class="text-xl font-semibold text-gray-800">Notes</h2>
                        <div class="flex space-x-2">
                            <button id="editorToggle"
                                class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                                <svg id="penIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                                </svg>
                            </button>
                            <button id="previewToggle"
                                class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm">
                                <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                            <button id="copyJournalButton"
                                class="px-3 py-1.5 bg-indigo-600 text-white text-sm font-medium rounded hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline align-text-bottom">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332
                                        0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0
                                        1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128
                                        1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5
                                        19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" />
                                </svg>
                            </button>
                            <button id="downloadJournalButton"
                                class="px-3 py-1.5 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline align-text-bottom">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                </svg>
                            </button>
                            <button id="clearJournalButton"
                                class="px-3 py-1.5 bg-red-500 text-white text-sm font-medium rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-4 h-4 align-text-bottom">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.576 0c1.256-.623 2.693-.936 4.136-.936s2.88.313 4.136.936m-1.022-.165L15.23 2.283A2.25 2.25 0 0013.487 1.5H10.52a2.25 2.25 0 00-1.742.783l-.897 1.524" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button id="closeJournalButton" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                </div>

                <div class="flex flex-col flex-grow overflow-hidden p-4">
                    <div class="flex-grow flex flex-col min-h-0 relative">
                        <textarea id="journalEditor"
                            class="absolute inset-0 p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent overflow-y-auto"
                            style="resize: none; height: 100%;"
                            placeholder="⚠️Remember, remember: this is a temporary notepad, which will disappear if you refresh your browser!⚠️ Start writing your journal entry here... Scripture references will be added automatically when you click the '+' on a scripture card. This journal uses 'markdown' syntax, which Google Docs supports. You can click the 'Preview' button to see your formatted journal entry, or copy this into a Google Doc to see it formatted."></textarea>
                        <div id="journalPreview"
                            class="absolute inset-0 p-3 border border-gray-200 rounded-md bg-gray-50 overflow-y-auto hidden">
                            <p class="text-gray-400 italic">Your formatted journal notes will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Instructions/README  -->
        <div id="searchHelpModalOverlay" class="modal-overlay">
            <div class="modal-box"><button id="searchHelpModalCloseButton" class="modal-close-button">&times;</button>
                <div class="modal-content">
                    <h3>What is this?</h3>
                    <p>What scripture search tool do you know of that can let you find all scriptures with both
                        "faith"
                        and "Jesus" in them? Or the verse first mentions "faith" and then "hope", in that order?
                        This
                        app solves those powerful search needs.</p>
                    <h3>How to Search</h3>
                    <p>You can search for exact phrases, use keywords with AND/OR, or enable full regular
                        expressions.
                    </p>
                    <h4>Keyword Search (AND/OR)</h4>
                    <p>If the "Search using regex" box is <strong>not</strong> checked:</p>
                    <ul>
                        <li><strong>AND Search:</strong> Type words separated by <code> AND </code> (e.g.,
                            <code>faith AND hope</code>). Finds verses with <strong>both</strong> words, in any
                            order.
                            Auto-converted to regex: <code>faith.*?hope|hope.*?faith</code>.
                        </li>
                        <li><strong>OR Search:</strong> Type words separated by <code> OR </code> (e.g.,
                            <code>love OR charity</code>). Finds verses with <strong>either</strong> word.
                            Auto-converted to regex: <code>love|charity</code>.
                        </li>
                        <li><strong>Note:</strong> <code>AND</code> takes precedence over <code>OR</code> if
                            both are
                            used without regex mode. Use regex mode for complex logic.</li>
                    </ul>
                    <h4>Exact Phrase Search</h4>
                    <p>If you don't use <code>AND</code>/<code>OR</code> and regex is off, it searches for the
                        exact
                        word sequence.</p>
                    <h4>Regular Expression (Regex) Search</h4>
                    <p>Check "Search using regex" to use regex patterns.</p>
                    <ul>
                        <li>Example: <code>^And it came to pass</code> (Starts with...).</li>
                        <li>Example: <code>Nephi|Lehi</code> (Contains either).</li>
                        <li>Example: <code>baptis(m|ed)</code> (Contains "baptism" or "baptised").</li>
                    </ul>
                    <p>Consider the "Case Sensitive" option.</p>
                    <h4>Verse Title Filter</h4>
                    <p>Always uses case-insensitive regex.</p>
                    <ul>
                        <li>Example: <code>^Moroni 10:</code> (All verses in Moroni 10).</li>
                        <li>Example: <code>1 Nephi 3:7$</code> (Exactly 1 Nephi 3:7).</li>
                        <li>Example: <code>(John|Luke) \d+:1$</code> (First verse of any chapter in John or
                            Luke).</li>
                    </ul>
                    <h4>Volume Filters</h4>
                    <p>Use checkboxes to select which volumes to include.</p>
                </div>
            </div>
        </div>

        <div id="statsHelpModalOverlay" class="modal-overlay">
            <div class="modal-box">
                <button id="statsHelpModalCloseButton" class="modal-close-button">&times;</button>
                <div class="modal-content">
                    <h3>Understanding the Statistics</h3>
                    <p>These statistics provide insights into the words and phrases found within the scriptures
                        matching
                        your search criteria.</p>
                    <h4>Overall Summary</h4>
                    <dl>
                        <dt>Total Unique Scriptures Matched</dt>
                        <dd>The total number of distinct scripture verses returned by your current search
                            filters and
                            criteria.</dd>
                    </dl>
                    <h4>Matches per Volume Chart</h4>
                    <p>A horizontal bar chart showing the number of matched scriptures belonging to each volume.
                    </p>
                    <h4>Word Forms Breakdown</h4>
                    <p>If you performed a non-regex search for a single word (e.g., "faith"), this section shows
                        the
                        counts for different words found in the results that start with your normalized search
                        term
                        (e.g., "faith", "faithful", "faithfulness"). This helps clarify how the total match
                        count
                        relates to specific word variations.</p>
                    <dl>
                        <dt>Word Form: Count</dt>
                        <dd>Shows the total number of times each specific word form appears across all matched
                            scriptures.</dd>
                    </dl>
                    <h4>N-gram Analysis Section</h4>
                    <p>This section shows the most common words (1-gram), pairs (2-gram), triplets (3-gram), or
                        quartets
                        (4-gram) found in the matched scriptures. Each tab provides a word/phrase cloud
                        visualization
                        and a frequency table.</p>
                    <p>Use the "Exclude Stop Words" checkbox to control whether common words (like "the", "a",
                        "is") are
                        included in the analysis. Excluding them often highlights more meaningful terms,
                        especially for
                        1-grams. Including them preserves the exact phrasing for 2-grams, 3-grams and 4-grams.
                    </p>
                    <h5>Word/Phrase Cloud</h5>
                    <p>A visual representation of the most frequent items (words, pairs, triplets, or quartets)
                        for the
                        selected N-gram size. Larger items appear more frequently. Clicking an item will search
                        for it
                        (only works well for single words).</p>
                    <h5>Frequency Tables</h5>
                    <p>These tables show detailed counts for individual words (1-gram), pairs (2-gram), triplets
                        (3-gram), or quartets (4-gram).</p>
                    <dl>
                        <dt>Word / Phrase / Triplet / Quartet</dt>
                        <dd>The specific normalized word (1-gram), sequence of two words (2-gram), sequence of
                            three
                            words (3-gram), or sequence of four words (4-gram) being analyzed.</dd>
                        <dt>Total Count</dt>
                        <dd>The absolute total number of times this <strong>specific item</strong> appears
                            across ALL
                            matched scriptures. An item can appear multiple times in a single scripture.</dd>
                        <dt>Unique Count</dt>
                        <dd>The number of unique scriptures (out of the 'Total Unique Scriptures Matched') that
                            contain
                            this <strong>specific item</strong> at least once.</dd>
                        <dt>Freq/Scripture (1-gram only)</dt>
                        <dd>Average number of times this specific word appears per matched scripture. Calculated
                            as:
                            <code>Word's Total Count / Total Unique Scriptures Matched</code>.
                        </dd>
                        <dt>Freq/Word (1-gram only)</dt>
                        <dd>The proportion of this specific word relative to all words counted across all
                            matched
                            scriptures (respecting the "Exclude Stop Words" setting). Calculated as:
                            <code>Word's Total Count / Total Words Counted</code>.
                        </dd>
                        <dt>Coverage (1-gram only)</dt>
                        <dd>The percentage of matched scriptures that contain this specific word at least once.
                            Calculated as: <code>Word's Unique Count / Total Unique Scriptures Matched</code>.
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <div id="stopWordsModalOverlay" class="modal-overlay">
            <div class="modal-box">
                <button id="stopWordsModalCloseButton" class="modal-close-button">&times;</button>
                <div class="modal-content">
                    <h3>Stop Words List</h3>
                    <p>These common words are excluded from N-gram analysis when the "Exclude Stop Words"
                        checkbox is
                        checked. This list helps focus the analysis on more significant terms.</p>
                    <ul id="stopWordsListDisplay" class="stop-words-list mt-4">
                        <li>Loading...</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="contextDrawerOverlay" class="modal-overlay">
            <div class="modal-box context-drawer-box">
                <button id="contextDrawerCloseButton" class="modal-close-button">&times;</button>
                <h3 id="contextDrawerTitle" class="text-xl font-semibold mb-4 text-gray-700">Chapter Context
                </h3>
                <div id="contextDrawerContent" class="space-y-2">
                    <p class="text-center text-gray-500">Loading context...</p>
                </div>
            </div>
        </div>

        <!-- Note button when you click "add to journal"  -->
        <div id="noteModal" class="modal-overlay">
            <div class="modal-box"> <button class="modal-close-button">&times;</button>
                <h3 class="text-xl font-semibold mb-4">Add a Note to your Journal</h3>
                <textarea id="noteTextarea" class="w-full p-2 border border-gray-300 rounded-md mb-4"
                    placeholder="Enter your note here..."></textarea>
                <p class="mb-4"><strong><span id="modalVerseTitle"></span></strong>&nbsp;<span
                        id="modalScriptureText"></span></p>
                <div class="flex justify-center">
                    <button id="saveNoteButton"
                        class="px-4 py-2 bg-blue-600 text-white text-center rounded-md hover:bg-blue-700">Add to
                        Journal</button>
                </div>
                <p class='text-center text-gray-500 text-xs mt-4'>Tip: shift+enter on Desktop</p>
            </div>
        </div>

    </div> <!-- End of .container -->

    <script>
        // --- Constants ---
        const HARDCODED_VOLUME_ORDER = ["Old Testament", "New Testament", "Book of Mormon", "Doctrine and Covenants", "Pearl of Great Price"];
        const STOP_WORDS = new Set(["a", "about", "above", "after", "again", "against", "all", "am", "an", "and", "any", "are", "aren't", "as", "at", "be", "because", "been", "before", "being", "below", "between", "both", "but", "by", "can't", "cannot", "could", "couldn't", "did", "didn't", "do", "does", "doesn't", "doing", "don't", "down", "during", "each", "few", "for", "from", "further", "had", "hadn't", "has", "hasn't", "have", "haven't", "having", "he", "he'd", "he'll", "he's", "her", "here", "here's", "hers", "herself", "him", "himself", "his", "how", "how's", "i", "i'd", "i'll", "i'm", "i've", "if", "in", "into", "is", "isn't", "it", "it's", "its", "itself", "let's", "me", "more", "most", "mustn't", "my", "myself", "no", "nor", "not", "of", "off", "on", "once", "only", "or", "other", "ought", "our", "ours", "ourselves", "out", "over", "own", "same", "shan't", "she", "she'd", "she'll", "she's", "should", "shouldn't", "so", "some", "such", "than", "that", "that's", "the", "their", "theirs", "them", "themselves", "then", "there", "there's", "these", "they", "they'd", "they'll", "they're", "they've", "this", "those", "through", "to", "too", "under", "until", "up", "very", "was", "wasn't", "we", "we'd", "we'll", "we're", "we've", "were", "weren't", "what", "what's", "when", "when's", "where", "where's", "which", "while", "who", "who's", "whom", "why", "why's", "with", "won't", "would", "wouldn't", "you", "you'd", "you'll", "you're", "you've", "your", "yours", "yourself", "yourselves"]);
        const WORD_CLOUD_LIMIT = 75;
        const RESULT_RENDER_LIMIT = 2000;

        // --- Global Variables ---
        const scriptureCache = {lds: null, currentResults: []};
        let allAvailableVolumes = [];
        let booksMap = new Map();
        let volumeCheckboxElements = [];
        let currentFrequencyData = {1: [], 2: [], 3: [], 4: []};
        let currentVolumeChartData = null;
        let currentSortColumn = "total";
        let currentSortDirection = "desc";
        let firstSearchPerformed = false;
        let currentNgramSize = 1;
        let wordCloudLayout = null;

        // --- DOM Element References ---
        const volumeCheckboxesContainer = document.getElementById("volumeCheckboxes");
        const allVolumesCheckbox = document.getElementById("allVolumesCheckbox");
        const searchInput = document.getElementById("searchInput");
        const searchInputError = document.getElementById("searchInputError");
        const verseTitleFilterInput = document.getElementById("verseTitleFilterInput");
        const verseTitleFilterError = document.getElementById("verseTitleFilterError");
        const regexSearchCheckbox = document.getElementById("regexSearch");
        const caseSensitiveCheckbox = document.getElementById("caseSensitive");
        const columnsByVolumeCheckbox = document.getElementById("columnsByVolume");
        const shuffleResultsCheckbox = document.getElementById("shuffleResults");
        const searchButton = document.getElementById("searchButton");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const resultsContainer = document.getElementById("resultsContainer");
        const noResultsMessage = document.getElementById("noResults");
        const resultsHeadingText = document.getElementById("resultsHeadingText");
        const searchStatus = document.getElementById("searchStatus");
        const fallbackMessage = document.getElementById("fallbackMessage");
        const howToSearchButton = document.getElementById("howToSearchButton");
        const searchHelpModalOverlay = document.getElementById("searchHelpModalOverlay");
        const searchHelpModalCloseButton = document.getElementById("searchHelpModalCloseButton");
        const explainStatsButton = document.getElementById("explainStatsButton");
        const statsHelpModalOverlay = document.getElementById("statsHelpModalOverlay");
        const statsHelpModalCloseButton = document.getElementById("statsHelpModalCloseButton");
        const showStopWordsButton = document.getElementById("showStopWordsButton");
        const stopWordsModalOverlay = document.getElementById("stopWordsModalOverlay");
        const stopWordsModalCloseButton = document.getElementById("stopWordsModalCloseButton");
        const stopWordsListDisplay = document.getElementById("stopWordsListDisplay");
        const contextDrawerOverlay = document.getElementById("contextDrawerOverlay");
        const contextDrawerCloseButton = document.getElementById("contextDrawerCloseButton");
        const contextDrawerTitle = document.getElementById("contextDrawerTitle");
        const contextDrawerContent = document.getElementById("contextDrawerContent");
        const advancedSearchArea = document.getElementById("advancedSearchArea");
        const toggleAdvancedSearchButton = document.getElementById("toggleAdvancedSearchButton");
        const toggleAdvancedSearchButtonText = document.getElementById("toggleAdvancedSearchButtonText");
        const toggleAdvancedSearchLink = document.getElementById("toggleAdvancedSearchLink");
        const showAdvancedOptionsButton = document.getElementById("showAdvancedOptionsButton");
        const toggleIconCollapse = toggleAdvancedSearchButton.querySelector(".toggle-icon-collapse");
        const toggleIconExpand = toggleAdvancedSearchButton.querySelector(".toggle-icon-expand");
        const scripturesTabButton = document.getElementById("scripturesTabButton");
        const statsTabButton = document.getElementById("statsTabButton");
        const scripturesContent = document.getElementById("scripturesContent");
        const statisticsContent = document.getElementById("statisticsContent");
        const scripturesTabCount = document.getElementById("scripturesTabCount");
        const statsDisplayArea = document.getElementById("statsDisplayArea");
        const statsTotalCount = document.getElementById("statsTotalCount");
        const statsVolumeChartContainer = document.getElementById("statsVolumeChartContainer");
        const statsWordFormsContainer = document.getElementById("statsWordFormsContainer");
        const statsWordFormsList = statsWordFormsContainer.querySelector('.word-form-list');
        const statsWordFormsPlaceholder = statsWordFormsContainer.querySelector('.no-forms');
        const ngramTabContainer = document.getElementById("ngramTabContainer");
        const ngramTabButtons = ngramTabContainer.querySelectorAll(".ngram-tab-button");
        const ngramTabContentContainer = document.getElementById("ngramTabContentContainer");
        const ngramTabContents = ngramTabContentContainer.querySelectorAll(".ngram-tab-content");
        const excludeStopWordsCheckbox = document.getElementById("excludeStopWordsCheckbox");
        const statsWordTable = document.getElementById("statsWordTable");
        const statsWordTableBody = document.getElementById("statsWordTableBody");
        const statsWordTableHeaders = statsWordTable.querySelectorAll("thead th[data-sort]");
        const statsBigramTable = document.getElementById("statsBigramTable");
        const statsBigramTableBody = document.getElementById("statsBigramTableBody");
        const statsBigramTableHeaders = statsBigramTable.querySelectorAll("thead th[data-sort]");
        const statsTrigramTable = document.getElementById("statsTrigramTable");
        const statsTrigramTableBody = document.getElementById("statsTrigramTableBody");
        const statsTrigramTableHeaders = statsTrigramTable.querySelectorAll("thead th[data-sort]");
        const statsQuatgramTable = document.getElementById("statsQuatgramTable");
        const statsQuatgramTableBody = document.getElementById("statsQuatgramTableBody");
        const statsQuatgramTableHeaders = statsQuatgramTable.querySelectorAll("thead th[data-sort]");
        const statsError = document.getElementById("statsError");

        // Journal DOM Elements
        const journalEditor = document.getElementById("journalEditor");
        const journalPreview = document.getElementById("journalPreview");
        const downloadJournalButton = document.getElementById("downloadJournalButton");
        const copyJournalButton = document.getElementById("copyJournalButton");
        const clearJournalButton = document.getElementById("clearJournalButton");

        // --- Modal Elements ---
        const noteModal = document.getElementById('noteModal');
        const modalScriptureTextEl = document.getElementById('modalScriptureText');
        const modalVerseTitleEl = document.getElementById('modalVerseTitle');
        const noteTextarea = document.getElementById('noteTextarea');
        const saveNoteButton = document.getElementById('saveNoteButton');
        const cancelNoteButton = document.getElementById('cancelNoteButton');
        const modalCloseButton = noteModal ? noteModal.querySelector('.modal-close-button') : null;

        // >>> ADD THESE LINES FOR DEBUGGING:
        console.log("noteModal:", noteModal);
        console.log("modalScriptureTextEl:", modalScriptureTextEl);
        console.log("modalVerseTitleEl:", modalVerseTitleEl);
        console.log("noteTextarea:", noteTextarea);
        console.log("saveNoteButton:", saveNoteButton);
        console.log("cancelNoteButton:", cancelNoteButton);
        console.log("modalCloseButton:", modalCloseButton);
        // <<< END DEBUGGING LINES


        // --- Dummy Scripture Data ---
        const DUMMY_SCRIPTURE_DATA = [
            {"volume_title": "Old Testament", "book_title": "Genesis", "book_short_title": "Gen.", "chapter_number": 1, "verse_number": 1, "verse_title": "Genesis 1:1", "scripture_text": "In the beginning God created the heaven and the earth."},
            {"volume_title": "Old Testament", "book_title": "Genesis", "book_short_title": "Gen.", "chapter_number": 1, "verse_number": 2, "verse_title": "Genesis 1:2", "scripture_text": "And the earth was without form, and void; and darkness was upon the face of the deep. And the Spirit of God moved upon the face of the waters."},
            {"volume_title": "Old Testament", "book_title": "Genesis", "book_short_title": "Gen.", "chapter_number": 1, "verse_number": 3, "verse_title": "Genesis 1:3", "verse_short_title": "Gen. 1:3", "scripture_text": "And God said, Let there be light: and there was light."},
            {"volume_title": "Old Testament", "book_title": "Genesis", "book_short_title": "Gen.", "chapter_number": 1, "verse_number": 4, "verse_title": "Genesis 1:4", "verse_short_title": "Gen. 1:4", "scripture_text": "And God saw the light, that it was good: and God divided the light from the darkness."},
            {"volume_title": "Old Testament", "book_title": "Genesis", "book_short_title": "Gen.", "chapter_number": 1, "verse_number": 5, "verse_title": "Genesis 1:5", "verse_short_title": "Gen. 1:5", "scripture_text": "And God called the light Day, and the darkness he called Night. And the evening and the morning were the first day."},
            {"volume_title": "Old Testament", "book_title": "Genesis", "book_short_title": "Gen.", "chapter_number": 1, "verse_number": 6, "verse_title": "Genesis 1:6", "verse_short_title": "Gen. 1:6", "scripture_text": "And God said, Let there be a firmament in the midst of the waters, and let it divide the waters from the waters."},
            {"volume_title": "New Testament", "book_title": "John", "book_short_title": "John", "chapter_number": 3, "verse_number": 16, "verse_title": "John 3:16", "verse_short_title": "John 3:16", "scripture_text": "For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life."}
        ];


        // --- Utility Functions ---
        function shuffleArray(array) {for (let i = array.length - 1; i > 0; i--) {const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]];} }
        function escapeRegex(str) {if (typeof str !== "string") return ""; return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");}
        function normalizeWord(word) {
            if (!word) return "";
            return word.toLowerCase()
                .replace(/^[^\w\s]+|[^\w\s]+$/g, "")
                .replace(/'s$/g, "")
                .replace(/[.,;:!?"'()[\]{}<>]/g, "");
        }
        function formatStat(value, decimalPlaces = 3) {if (typeof value !== 'number' || !isFinite(value)) {return "N/A";} return value.toFixed(decimalPlaces);}
        function formatPercentage(value, decimalPlaces = 1) {if (typeof value !== 'number' || !isFinite(value)) {return "N/A";} return (value * 100).toFixed(decimalPlaces) + '%';}

        // --- Button Feedback ---
        function showButtonFeedback(buttonElement, feedbackHTML, timeoutDuration = 1500) {
            const originalHTML = buttonElement.innerHTML;
            buttonElement.innerHTML = feedbackHTML;
            setTimeout(() => {
                buttonElement.innerHTML = originalHTML;
            }, timeoutDuration);
            console.log(`Button feedback shown for ${timeoutDuration}ms: ${feedbackHTML}`)
        }

        // --- Note Modal Helper Functions ---
        function showModal() {
            if (noteModal) {
                console.log("noteModal showModal: Adding .active class");
                noteModal.classList.add('active');
                // Delay the focus call slightly
                setTimeout(() => {
                    if (noteTextarea) {
                        noteTextarea.focus();
                        console.log("noteModal showModal: Attempted to focus on noteTextarea after short delay.");
                        // You can also check document.activeElement here to see what has focus
                        // console.log("Currently active element:", document.activeElement);
                    } else {
                        console.error("noteModal showModal (in setTimeout): noteTextarea element not found for focusing!");
                    }
                }, 50);
            } else {
                console.error("noteModal showModal: noteModal element not found!");
            }
        }

        function hideModal() {
            if (noteModal) {
                console.log("noteModal hideModal: Removing .active class");
                noteModal.classList.remove('active');
                if (noteTextarea) noteTextarea.value = ''; // Clear textarea on close
            } else {
                console.error("noteModal hideModal: noteModal element not found!");
            }
        }

        // --- Data Fetching and Initialization ---
        async function fetchScriptureData() {
            if (scriptureCache.lds) {
                console.log("Using cached scripture data.");
                return scriptureCache.lds;
            }
            console.log("Fetching scripture data...");
            loadingIndicator.classList.remove("hidden");
            resultsContainer.innerHTML = "";
            noResultsMessage.classList.add("hidden");
            fallbackMessage.textContent = "";
            clearStatisticsDisplay();
            statsTabButton.disabled = true;
            statsTabButton.classList.remove("active");
            scripturesTabButton.classList.add("active");
            scripturesContent.classList.add("active");
            statisticsContent.classList.remove("active");

            let data;
            let usingFallback = false;

            try {
                const response = await fetch("lds-scriptures.json");
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error("Scripture data is not in the expected array format.");
                }
                console.log(`Successfully fetched and parsed ${data.length} scripture entries.`);
            } catch (error) {
                console.warn(`Error loading LDS scriptures from JSON: ${error.message}. Using fallback dummy data.`);
                data = DUMMY_SCRIPTURE_DATA;
                usingFallback = true;
                fallbackMessage.textContent = "⚠️ Could not load full scripture data. Using limited fallback data.";
            }

            try {
                scriptureCache.lds = data;
                const foundVolumesSet = new Set();
                booksMap.clear();

                data.forEach((verse) => {
                    if (verse && typeof verse.volume_title === "string" && typeof verse.book_title === "string") {
                        const volumeTitle = verse.volume_title;
                        foundVolumesSet.add(volumeTitle);
                        if (!booksMap.has(volumeTitle)) booksMap.set(volumeTitle, new Set());
                        booksMap.get(volumeTitle).add(verse.book_title);
                    } else {
                        console.warn("Skipping malformed verse entry:", verse);
                    }
                });

                const orderedVolumes = [];
                const remainingVolumes = new Set(foundVolumesSet);
                HARDCODED_VOLUME_ORDER.forEach((orderedVolume) => {
                    if (remainingVolumes.has(orderedVolume)) {
                        orderedVolumes.push(orderedVolume);
                        remainingVolumes.delete(orderedVolume);
                    }
                });
                const sortedRemaining = Array.from(remainingVolumes).sort();
                allAvailableVolumes = [...orderedVolumes, ...sortedRemaining];

                populateVolumeCheckboxes();
                return data;
            } catch (processingError) {
                console.error("Error processing scripture data (real or fallback):", processingError);
                scripturesContent.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative max-w-4xl mx-auto" role="alert"><strong class="font-bold">Data Processing Error!</strong><span class="block sm:inline"> ${processingError.message}</span></div>`;
                scripturesContent.classList.add("active");
                statisticsContent.classList.remove("active");
                resultsHeadingText.textContent = "Error";
                scripturesTabCount.textContent = "!";
                searchStatus.textContent = "Failed to process scripture data.";
                fallbackMessage.textContent = "";
                return [];
            } finally {
                loadingIndicator.classList.add("hidden");
                console.log(`Finished fetchScriptureData attempt. ${usingFallback ? '(Using Fallback Data)' : ''}`);
            }
        }
        function populateVolumeCheckboxes() {
            volumeCheckboxesContainer.innerHTML = ""; volumeCheckboxElements = [];
            allAvailableVolumes.forEach((volume) => {
                const div = document.createElement("div"); div.className = "flex items-center";
                const checkbox = document.createElement("input"); checkbox.type = "checkbox"; checkbox.id = `vol-${volume.replace(/[^a-zA-Z0-9]/g, "-")}`; checkbox.value = volume; checkbox.checked = true;
                checkbox.className = "w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded volume-checkbox mr-2"; checkbox.addEventListener("change", handleVolumeCheckboxChange);
                const label = document.createElement("label"); label.htmlFor = checkbox.id; label.textContent = volume; label.className = "text-sm text-gray-700 cursor-pointer";
                div.appendChild(checkbox); div.appendChild(label); volumeCheckboxesContainer.appendChild(div); volumeCheckboxElements.push(checkbox);
            }); updateAllVolumesCheckboxState();
        }

        // --- Event Handlers ---
        function handleVolumeCheckboxChange() {updateAllVolumesCheckboxState();}
        allVolumesCheckbox.addEventListener("change", () => {const isChecked = allVolumesCheckbox.checked; volumeCheckboxElements.forEach((checkbox) => (checkbox.checked = isChecked));});
        function updateAllVolumesCheckboxState() {
            const totalCheckboxes = volumeCheckboxElements.length; if (totalCheckboxes === 0) {allVolumesCheckbox.checked = false; allVolumesCheckbox.indeterminate = false; return;}
            const checkedCount = volumeCheckboxElements.filter((checkbox) => checkbox.checked).length;
            if (checkedCount === totalCheckboxes) {allVolumesCheckbox.checked = true; allVolumesCheckbox.indeterminate = false;}
            else if (checkedCount > 0) {allVolumesCheckbox.checked = false; allVolumesCheckbox.indeterminate = true;}
            else {allVolumesCheckbox.checked = false; allVolumesCheckbox.indeterminate = false;}
        }

        // --- Modal Control ---
        function openModal(overlayElement) {overlayElement.classList.add("active");}
        function closeModal(overlayElement) {overlayElement.classList.remove("active");}
        howToSearchButton.addEventListener("click", () => openModal(searchHelpModalOverlay));
        searchHelpModalCloseButton.addEventListener("click", () => closeModal(searchHelpModalOverlay));
        searchHelpModalOverlay.addEventListener("click", (event) => {if (event.target === searchHelpModalOverlay) closeModal(searchHelpModalOverlay);});
        explainStatsButton.addEventListener("click", () => openModal(statsHelpModalOverlay));
        statsHelpModalCloseButton.addEventListener("click", () => closeModal(statsHelpModalOverlay));
        statsHelpModalOverlay.addEventListener("click", (event) => {if (event.target === statsHelpModalOverlay) closeModal(statsHelpModalOverlay);});
        showStopWordsButton.addEventListener("click", () => openModal(stopWordsModalOverlay));
        stopWordsModalCloseButton.addEventListener("click", () => closeModal(stopWordsModalOverlay));
        stopWordsModalOverlay.addEventListener("click", (event) => {if (event.target === stopWordsModalOverlay) closeModal(stopWordsModalOverlay);});
        contextDrawerCloseButton.addEventListener("click", () => closeModal(contextDrawerOverlay));
        contextDrawerOverlay.addEventListener("click", (event) => {if (event.target === contextDrawerOverlay) closeModal(contextDrawerOverlay);});
        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                if (searchHelpModalOverlay.classList.contains("active")) closeModal(searchHelpModalOverlay);
                if (statsHelpModalOverlay.classList.contains("active")) closeModal(statsHelpModalOverlay);
                if (stopWordsModalOverlay.classList.contains("active")) closeModal(stopWordsModalOverlay);
                if (contextDrawerOverlay.classList.contains("active")) closeModal(contextDrawerOverlay);
            }
        });

        // --- Advanced Search Area Collapse/Expand ---
        function toggleAdvancedSearchArea(forceCollapse = null) {
            const isCurrentlyCollapsed = advancedSearchArea.classList.contains("collapsed"); const shouldCollapse = forceCollapse === null ? !isCurrentlyCollapsed : forceCollapse;
            console.log(`Toggling advanced search. Currently collapsed: ${isCurrentlyCollapsed}, Forcing collapse: ${forceCollapse}, Will collapse: ${shouldCollapse}`);
            if (shouldCollapse) {
                advancedSearchArea.classList.add("collapsed"); toggleAdvancedSearchButtonText.textContent = "Show Advanced"; toggleIconCollapse.classList.add("hidden");
                toggleIconExpand.classList.remove("hidden"); toggleAdvancedSearchLink.style.display = 'block'; toggleAdvancedSearchButton.style.display = 'none';
            } else {
                advancedSearchArea.classList.remove("collapsed"); toggleAdvancedSearchButtonText.textContent = "Hide Advanced"; toggleIconCollapse.classList.remove("hidden");
                toggleIconExpand.classList.add("hidden"); toggleAdvancedSearchLink.style.display = 'none'; toggleAdvancedSearchButton.style.display = 'inline-flex';
            }
        }
        toggleAdvancedSearchButton.addEventListener("click", () => toggleAdvancedSearchArea());
        showAdvancedOptionsButton.addEventListener("click", () => toggleAdvancedSearchArea(false));

        // --- Main Tab Switching (Scriptures/Statistics) ---
        function switchTab(tabName) {
            console.log("Switching main tab to:", tabName);
            scripturesContent.classList.remove("active");
            statisticsContent.classList.remove("active");
            scripturesTabButton.classList.remove("active");
            statsTabButton.classList.remove("active");

            if (tabName === "scriptures") {
                scripturesContent.classList.add("active");
                scripturesTabButton.classList.add("active");
            } else if (tabName === "statistics") {
                if (!statsTabButton.disabled) {
                    statisticsContent.classList.add("active");
                    statsTabButton.classList.add("active");
                    switchNgramTab(`${currentNgramSize}gram`);
                } else {
                    console.warn("Attempted to switch to disabled stats tab. Staying on scriptures tab.");
                    scripturesContent.classList.add("active");
                    scripturesTabButton.classList.add("active");
                }
            }
        }
        scripturesTabButton.addEventListener("click", () => switchTab("scriptures"));
        statsTabButton.addEventListener("click", () => switchTab("statistics"));

        // --- N-gram Tab Switching (within Statistics) ---
        function switchNgramTab(targetTab) {
            console.log("Switching N-gram tab to:", targetTab);
            currentNgramSize = parseInt(targetTab.replace('gram', ''), 10);

            ngramTabContents.forEach(content => content.classList.remove('active'));
            ngramTabButtons.forEach(button => button.classList.remove('active'));

            const activeContent = document.getElementById(targetTab + 'Content');
            const activeButton = ngramTabContainer.querySelector(`[data-ngram-tab="${targetTab}"]`);

            if (activeContent) activeContent.classList.add('active');
            if (activeButton) activeButton.classList.add('active');

            if (statisticsContent.classList.contains('active')) {
                if (currentVolumeChartData) {
                    renderVolumeChart(currentVolumeChartData);
                } else {
                    statsVolumeChartContainer.innerHTML = '<p class="text-xs text-gray-500 italic text-center pt-4">Perform a search to generate volume chart.</p>';
                }
                renderFrequencyTable();
                const cloudContainerId = `wordCloudContainer${currentNgramSize}gram`;
                if (document.getElementById(cloudContainerId)) {
                    renderWordCloud(currentNgramSize);
                } else {
                    console.log(`No word cloud container found for ${currentNgramSize}-gram.`);
                    const container = document.getElementById(cloudContainerId);
                    if (container) {
                        const typeName = currentNgramSize === 1 ? 'word' :
                            currentNgramSize === 2 ? 'phrase' :
                                currentNgramSize === 3 ? 'triplet' : 'quartet';
                        container.innerHTML = `<p class="wordCloudStatus text-center text-gray-500 p-4">Perform a search to generate ${typeName} cloud.</p>`;
                    }
                }
            } else {
                console.log("N-gram switch called, but statistics tab is not active. Deferring rendering.");
            }
        }
        ngramTabButtons.forEach(button => {
            button.addEventListener('click', () => switchNgramTab(button.dataset.ngramTab));
        });

        // --- Stop Words Checkbox Handler ---
        excludeStopWordsCheckbox.addEventListener('change', () => {
            console.log("Exclude Stop Words checkbox changed:", excludeStopWordsCheckbox.checked);
            if (!statsTabButton.disabled && scriptureCache.currentResults.length > 0) {
                console.log("Recalculating statistics due to stop word toggle change...");
                try {
                    calculateAndDisplayStatistics(
                        scriptureCache.currentResults,
                        scriptureCache.currentResults.length,
                        searchInput.value.trim(),
                        regexSearchCheckbox.checked
                    );
                    switchNgramTab(`${currentNgramSize}gram`);
                } catch (error) {
                    console.error("Error recalculating statistics after stop word toggle:", error);
                    statsError.textContent = `Error updating statistics: ${error.message}`;
                    statsError.classList.remove('hidden');
                }
            } else {
                console.log("Stop word checkbox changed, but no results to recalculate stats for.");
            }
        });

        // --- Search Logic ---
        function getSelectedVolumes() {return volumeCheckboxElements.filter((checkbox) => checkbox.checked).map((checkbox) => checkbox.value);}
        async function performSearch() {
            console.log("--- Starting Search ---");

            const originalHTML = searchButton.innerHTML;
            searchButton.innerHTML = 'and ye shall find';
            setTimeout(() => {
                searchButton.innerHTML = originalHTML;
            }, 2000)

            if (firstSearchPerformed) {console.log("Collapsing advanced options after subsequent search."); toggleAdvancedSearchArea(true);}
            else {console.log("First search, not collapsing advanced options yet.");}

            searchInputError.textContent = ""; verseTitleFilterError.textContent = ""; searchStatus.textContent = "";
            resultsContainer.innerHTML = ""; noResultsMessage.classList.add("hidden"); clearStatisticsDisplay(); statsTabButton.disabled = true;
            statsError.classList.add('hidden'); statsError.textContent = '';
            fallbackMessage.textContent = "";
            scriptureCache.currentResults = [];
            switchTab("scriptures");

            let searchTerm = searchInput.value.trim(); const originalSearchTerm = searchTerm;
            const verseTitleFilterTerm = verseTitleFilterInput.value.trim();
            const selectedVolumes = getSelectedVolumes(); let useRegex = regexSearchCheckbox.checked; const isCaseSensitive = caseSensitiveCheckbox.checked;
            const shouldDisplayColumns = columnsByVolumeCheckbox.checked; const shouldShuffle = shuffleResultsCheckbox.checked; let wasAutoConverted = false;

            if (selectedVolumes.length === 0) {console.log("Search stopped: No volumes selected."); resultsContainer.className = ""; resultsHeadingText.textContent = "Results"; scripturesTabCount.textContent = "0"; noResultsMessage.textContent = "Please select at least one volume to search."; noResultsMessage.classList.remove("hidden"); loadingIndicator.classList.add("hidden"); return;}
            console.log("Selected Volumes:", selectedVolumes);

            let generatedRegexString = null; if (!useRegex && searchTerm) {const andMatch = searchTerm.match(/^(.*?)\s+AND\s+(.*?)$/i); const orMatch = searchTerm.match(/^(.*?)\s+OR\s+(.*?)$/i); if (andMatch) {const term1 = escapeRegex(andMatch[1].trim()); const term2 = escapeRegex(andMatch[2].trim()); generatedRegexString = `(${term1}.*?${term2}|${term2}.*?${term1})`; useRegex = true; wasAutoConverted = true; console.log("AND detected, using regex:", generatedRegexString);} else if (orMatch) {const term1 = escapeRegex(orMatch[1].trim()); const term2 = escapeRegex(orMatch[2].trim()); generatedRegexString = `(${term1}|${term2})`; useRegex = true; wasAutoConverted = true; console.log("OR detected, using regex:", generatedRegexString);} }
            let mainSearchRegex = null; if (useRegex && (searchTerm || generatedRegexString)) {try {const pattern = generatedRegexString || searchTerm; if (!pattern) throw new Error("Regex pattern is empty."); mainSearchRegex = new RegExp(pattern, isCaseSensitive ? "g" : "gi"); console.log("Main search regex compiled:", mainSearchRegex);} catch (e) {console.error("Invalid main search regex:", e); searchInputError.textContent = `Invalid Regex: ${e.message}`; return;} }
            let verseTitleRegex = null; if (verseTitleFilterTerm) {try {verseTitleRegex = new RegExp(verseTitleFilterTerm, "i"); console.log("Verse title regex compiled:", verseTitleRegex);} catch (e) {console.error("Invalid verse title regex:", e); verseTitleFilterError.textContent = `Invalid Regex: ${e.message}`; return;} }

            loadingIndicator.classList.remove("hidden");
            resultsContainer.className = shouldDisplayColumns ? "results-flex-container" : "results-grid-container";
            let results = [];
            try {
                const data = await fetchScriptureData();
                if (!Array.isArray(data) || data.length === 0) {console.error("performSearch cannot proceed: Invalid or empty data received from fetchScriptureData."); if (!scripturesContent.querySelector(".bg-red-100")) {resultsHeadingText.textContent = "Results"; scripturesTabCount.textContent = "0"; noResultsMessage.textContent = "No scripture data is available to search."; noResultsMessage.classList.remove("hidden");} loadingIndicator.classList.add("hidden"); return;}
                console.log(`Processing ${data.length} scripture entries (real or fallback).`);

                console.log("Filtering by volume..."); let filteredData = data; const volumesSet = new Set(selectedVolumes); filteredData = filteredData.filter((verse) => verse && typeof verse.volume_title === "string" && volumesSet.has(verse.volume_title)); console.log(`After volume filter: ${filteredData.length} entries.`);
                console.log("Filtering by search term:", originalSearchTerm, "Use regex:", useRegex); if (searchTerm || generatedRegexString) {if (useRegex && mainSearchRegex) {results = filteredData.filter((verse) => verse && typeof verse.scripture_text === "string" && mainSearchRegex.test(verse.scripture_text)); if (mainSearchRegex.global) mainSearchRegex.lastIndex = 0;} else if (!useRegex && searchTerm) {const finalSearchTerm = isCaseSensitive ? searchTerm : searchTerm.toLowerCase(); results = filteredData.filter((verse) => {const text = verse && typeof verse.scripture_text === "string" ? (isCaseSensitive ? verse.scripture_text : verse.scripture_text.toLowerCase()) : ""; return text.includes(finalSearchTerm);});} else {results = filteredData;} } else {results = filteredData;} console.log(`After search term filter: ${results.length} entries.`);
                if (verseTitleRegex) {console.log("Filtering by verse title regex:", verseTitleRegex); results = results.filter((verse) => verse && typeof verse.verse_title === "string" && verseTitleRegex.test(verse.verse_title)); if (verseTitleRegex.global) verseTitleRegex.lastIndex = 0; console.log(`After verse title filter: ${results.length} entries.`);}

                scriptureCache.currentResults = results;

                if (shouldShuffle && results.length > 0) {console.log("Shuffling results..."); shuffleArray(results);}

                let statusParts = []; if (originalSearchTerm) {statusParts.push(`Searching for "${originalSearchTerm}"`); if (useRegex) statusParts.push(`using ${wasAutoConverted ? "auto-converted " : ""}regex`); else statusParts.push(`as exact phrase`); statusParts.push(isCaseSensitive ? "(case-sensitive)" : "(case-insensitive)");} else {statusParts.push("Showing all verses");} if (verseTitleFilterTerm) statusParts.push(`filtering titles by regex "${verseTitleFilterTerm}"`); if (selectedVolumes.length < allAvailableVolumes.length) statusParts.push(`in selected volumes`); else statusParts.push(`in all volumes`); searchStatus.textContent = statusParts.join(", ") + "."; console.log("Search Status:", searchStatus.textContent);

                const resultCount = results.length;
                resultsHeadingText.textContent = `Scriptures (${resultCount > RESULT_RENDER_LIMIT ? '>' + RESULT_RENDER_LIMIT : resultCount})`;
                scripturesTabCount.textContent = resultCount > RESULT_RENDER_LIMIT ? `>${RESULT_RENDER_LIMIT}` : resultCount;

                if (resultCount > RESULT_RENDER_LIMIT) {
                    console.warn(`Search returned ${resultCount} results, exceeding the limit of ${RESULT_RENDER_LIMIT}.`);
                    resultsContainer.innerHTML = "";
                    noResultsMessage.innerHTML = `<p class="text-orange-700 font-semibold">Search returned ${resultCount.toLocaleString()} results, which is more than the display limit of ${RESULT_RENDER_LIMIT.toLocaleString()}.</p><p class="text-gray-600 mt-2">Please refine your search terms or filters to narrow down the results.</p>`;
                    noResultsMessage.classList.remove("hidden");
                    statsTabButton.disabled = true;
                    clearStatisticsDisplay();
                    scriptureCache.currentResults = [];
                    if (!firstSearchPerformed) {firstSearchPerformed = true; console.log("First search performed flag set to true (results exceeded limit)."); console.log("Collapsing advanced options after first search (results exceeded limit)."); toggleAdvancedSearchArea(true);}
                } else if (resultCount > 0) {
                    console.log("Displaying results and calculating stats...");
                    try {
                        displayResults(results, originalSearchTerm, isCaseSensitive, shouldDisplayColumns);
                        calculateAndDisplayStatistics(results, resultCount, originalSearchTerm, useRegex);
                        statsTabButton.disabled = false;
                        console.log("Stats tab enabled.");
                    } catch (statsErrorCaught) {
                        console.error("Error during statistics calculation or rendering:", statsErrorCaught);
                        statsTabButton.disabled = true;
                        clearStatisticsDisplay();
                        scriptureCache.currentResults = [];
                        statsError.textContent = `An error occurred while generating statistics: ${statsErrorCaught.message}. Try refining your search.`;
                        statsError.classList.remove('hidden');
                    }
                    if (!firstSearchPerformed) {firstSearchPerformed = true; console.log("First search performed flag set to true."); console.log("Collapsing advanced options after first search display."); toggleAdvancedSearchArea(true);}
                } else {
                    console.log("No matches found for criteria."); resultsContainer.className = "";
                    noResultsMessage.textContent = "No matches found for your criteria.";
                    noResultsMessage.classList.remove("hidden"); statsTabButton.disabled = true;
                    clearStatisticsDisplay(); console.log("Stats tab kept disabled.");
                    scriptureCache.currentResults = [];
                }
            } catch (error) {
                console.error("Error during search processing:", error); resultsContainer.className = "";
                scripturesContent.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative max-w-4xl mx-auto" role="alert"><strong class="font-bold">Search Error!</strong><span class="block sm:inline"> ${error.message}</span></div>`;
                resultsHeadingText.textContent = "Error"; scripturesTabCount.textContent = "!"; searchStatus.textContent = "Search failed due to an error.";
                noResultsMessage.classList.add("hidden"); statsTabButton.disabled = true; clearStatisticsDisplay();
                scriptureCache.currentResults = [];
            } finally {loadingIndicator.classList.add("hidden"); console.log("--- Search Finished ---");}
        }

        // --- Scripture Card Display Logic ---
        function createResultCard(verse, searchTerm, isCaseSensitive, isForContextDrawer = false) {
            const card = document.createElement("div");
            card.className = "result-card flex flex-row overflow-hidden rounded-lg shadow-md bg-white border border-gray-200";

            // Main content area (left side)
            const contentWrapper = document.createElement("div");
            contentWrapper.className = "flex-grow p-4 overflow-y-auto"; // p-4 for padding around text

            const scriptureText = verse?.scripture_text ?? "[Scripture text missing]";
            const verseTitle = verse?.verse_title ?? "[Verse title missing]";
            const bookTitle = verse?.book_title ?? "[Book missing]";
            const chapterNum = verse?.chapter_number ?? "?";
            const verseNum = verse?.verse_number ?? "?";

            let highlightedText = scriptureText;
            if (searchTerm && scriptureText !== "[Scripture text missing]") {
                try {
                    let highlightPattern = searchTerm;
                    let highlightFlags = isCaseSensitive ? "g" : "gi";
                    if (typeof regexSearchCheckbox !== 'undefined' && !regexSearchCheckbox.checked && typeof escapeRegex === 'function') {
                        highlightPattern = escapeRegex(searchTerm);
                    }
                    const regex = new RegExp(highlightPattern, highlightFlags);
                    highlightedText = scriptureText.replace(regex, (match) => `<span class="highlight">${match}</span>`);
                } catch (e) {
                    console.warn(`Regex error during highlighting for term "${searchTerm}":`, e);
                    highlightedText = scriptureText;
                }
            }

            const headingElement = document.createElement("h3");
            headingElement.className = "scripture-title-heading font-semibold text-base text-blue-800 mb-2";
            headingElement.textContent = verseTitle;

            if (!isForContextDrawer) {
                headingElement.classList.add("clickable-heading", "hover:text-blue-600", "cursor-pointer");
                headingElement.title = "Click to view context";
                if (typeof openContextDrawer === 'function') {
                    headingElement.addEventListener('click', () => openContextDrawer(verse));
                }
            }
            contentWrapper.appendChild(headingElement);

            const scriptureParagraph = document.createElement("p");
            scriptureParagraph.className = "text-sm text-gray-700";
            scriptureParagraph.innerHTML = highlightedText;
            contentWrapper.appendChild(scriptureParagraph);

            card.appendChild(contentWrapper); // Content added to card

            // Buttons column (right side)
            const buttonsColumn = document.createElement("div");
            // w-auto to shrink to content, p-1 for minimal padding around buttons,
            // items-center to center buttons if they don't fill the column width (though they will with w-full)
            buttonsColumn.className = "flex flex-col items-center justify-start p-1.5 space-y-1.5 bg-slate-50 border-l border-gray-200 w-auto flex-shrink-0";

            const copyData = `> ${scriptureText} (${verseTitle})`;

            // --- Create Buttons ---
            // Common classes for icon-only buttons. p-1.5 for a tighter button.
            const commonButtonClasses = "flex items-center justify-center p-1.5 bg-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:bg-gray-200 rounded-md transition-colors duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500";

            // 1. Copy Button
            const copyButton = document.createElement("button");
            copyButton.className = `copy-button ${commonButtonClasses}`; // Make sure it uses commonButtonClasses
            copyButton.title = "Copy scripture text and title";
            copyButton.dataset.copy = escape(copyData);
            copyButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" />
                </svg>`;
            buttonsColumn.appendChild(copyButton); // CRITICAL: Ensure it's appended to buttonsColumn

            // 2. Add to Journal Button
            const addJournalButton = document.createElement("button");
            addJournalButton.className = `add-to-journal-button ${commonButtonClasses}`;
            addJournalButton.title = "Add to Journal";
            addJournalButton.dataset.verseTitle = escape(verseTitle);
            addJournalButton.dataset.scriptureText = escape(scriptureText);
            addJournalButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>`;
            buttonsColumn.appendChild(addJournalButton);

            // 3. Search on Google Button
            const searchGoogleButton = document.createElement("button");
            searchGoogleButton.className = `${commonButtonClasses}`;
            searchGoogleButton.title = "Search scripture text on Google";
            searchGoogleButton.onclick = () => window.open(`https://www.google.com/search?q=${encodeURIComponent(scriptureText)}`, '_blank');
            searchGoogleButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                </svg>`;
            buttonsColumn.appendChild(searchGoogleButton);

            // 4. Search on Church Website Link (styled as a button)
            const searchChurchSiteLink = document.createElement("a");
            searchChurchSiteLink.className = `block ${commonButtonClasses}`;
            searchChurchSiteLink.href = `https://www.churchofjesuschrist.org/search?facet=all&lang=eng&query=${encodeURIComponent(bookTitle)}+${chapterNum}%3A${verseNum}`;
            searchChurchSiteLink.target = "_blank";
            searchChurchSiteLink.rel = "noopener noreferrer";
            searchChurchSiteLink.title = "Search verse on Church Website";
            searchChurchSiteLink.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
                </svg>`;
            buttonsColumn.appendChild(searchChurchSiteLink);

            card.appendChild(buttonsColumn); // Buttons column added to card, AFTER contentWrapper

            return card;
        }
        function displayResults(results, searchTerm, isCaseSensitive, displayColumns) {
            resultsContainer.innerHTML = "";
            resultsContainer.className = displayColumns ? "results-flex-container" : "results-grid-container";
            noResultsMessage.classList.add("hidden");

            if (displayColumns) {
                const resultsByVolume = results.reduce((acc, verse) => {if (verse && typeof verse.volume_title === "string") {const volume = verse.volume_title; if (!acc[volume]) acc[volume] = []; acc[volume].push(verse);} return acc;}, {});
                const createVolumeColumn = (volumeName, verses) => {const columnDiv = document.createElement("div"); columnDiv.className = "volume-column"; const headerArea = document.createElement("div"); headerArea.className = "volume-column-header-area"; const header = document.createElement("h3"); header.textContent = volumeName; header.className = "volume-column-header"; headerArea.appendChild(header); const subheader = document.createElement("div"); subheader.textContent = `${verses.length} scripture${verses.length !== 1 ? "s" : ""}`; subheader.className = "volume-column-subheader"; headerArea.appendChild(subheader); columnDiv.appendChild(headerArea); const contentDiv = document.createElement("div"); contentDiv.className = "volume-column-content"; verses.forEach((verse) => {const card = createResultCard(verse, searchTerm, isCaseSensitive, false); contentDiv.appendChild(card);}); columnDiv.appendChild(contentDiv); return columnDiv;};
                HARDCODED_VOLUME_ORDER.forEach((volumeName) => {if (resultsByVolume[volumeName]?.length > 0) {const column = createVolumeColumn(volumeName, resultsByVolume[volumeName]); resultsContainer.appendChild(column); delete resultsByVolume[volumeName];} });
                Object.keys(resultsByVolume).sort().forEach((volumeName) => {if (resultsByVolume[volumeName].length > 0) {const column = createVolumeColumn(volumeName, resultsByVolume[volumeName]); resultsContainer.appendChild(column);} });
            } else {
                results.forEach((verse) => {const card = createResultCard(verse, searchTerm, isCaseSensitive, false); resultsContainer.appendChild(card);});
            }
        }

        // --- Context Drawer Logic ---
        function openContextDrawer(clickedVerse) {
            console.log("Opening context drawer for:", clickedVerse);
            if (!scriptureCache.lds || scriptureCache.lds.length === 0) {
                contextDrawerTitle.textContent = "Error";
                contextDrawerContent.innerHTML = '<p class="text-center text-red-500">Scripture data not loaded. Cannot display context.</p>';
                openModal(contextDrawerOverlay);
                return;
            }

            contextDrawerTitle.textContent = `${clickedVerse.book_title} - Chapter ${clickedVerse.chapter_number}`;
            contextDrawerContent.innerHTML = '<p class="text-center text-gray-500">Loading context...</p>';

            const chapterVerses = scriptureCache.lds.filter(
                v => v.book_title === clickedVerse.book_title && v.chapter_number === clickedVerse.chapter_number
            ).sort((a, b) => a.verse_number - b.verse_number);

            if (chapterVerses.length === 0) {
                contextDrawerContent.innerHTML = '<p class="text-center text-gray-500">No verses found for this chapter.</p>';
                openModal(contextDrawerOverlay);
                return;
            }
            const versesToShow = chapterVerses;
            contextDrawerContent.innerHTML = "";
            let currentVerseElement = null;

            versesToShow.forEach(verse => {
                const cardElement = createResultCard(verse, null, false, true);
                if (verse.verse_number === clickedVerse.verse_number) {
                    cardElement.classList.add('current-context-verse');
                    cardElement.id = `context-verse-${verse.verse_number}`;
                    currentVerseElement = cardElement;
                }
                contextDrawerContent.appendChild(cardElement);
            });

            if (versesToShow.length === 0) {
                contextDrawerContent.innerHTML = '<p class="text-center text-gray-500">No surrounding verses to display.</p>';
            }

            openModal(contextDrawerOverlay);

            if (currentVerseElement) {
                setTimeout(() => {
                    currentVerseElement.scrollIntoView({behavior: 'smooth', block: 'center'});
                }, 100);
            }
        }


        // --- N-gram Calculation ---
        function calculateNGrams(results, n, excludeStopWords) {
            console.log(`Calculating ${n}-grams... (Exclude Stop Words: ${excludeStopWords})`);
            const ngramCounts = {};
            const ngramUniqueCounts = {};

            results.forEach((verse) => {
                const text = verse.scripture_text || "";
                const normalizedWords = text.split(/\s+/)
                    .map(normalizeWord)
                    .filter(word => word);

                const wordsToUse = excludeStopWords
                    ? normalizedWords.filter(word => !STOP_WORDS.has(word))
                    : normalizedWords;

                const itemsInThisVerse = new Set();

                if (wordsToUse.length >= n) {
                    for (let i = 0; i <= wordsToUse.length - n; i++) {
                        const item = wordsToUse.slice(i, i + n).join(" ");
                        if (item.trim()) {
                            ngramCounts[item] = (ngramCounts[item] || 0) + 1;
                            if (!itemsInThisVerse.has(item)) {
                                ngramUniqueCounts[item] = (ngramUniqueCounts[item] || 0) + 1;
                                itemsInThisVerse.add(item);
                            }
                        }
                    }
                }
            });

            const frequencyData = Object.keys(ngramCounts)
                .map(item => ({
                    [n === 1 ? 'word' : 'phrase']: item,
                    total: ngramCounts[item],
                    unique: ngramUniqueCounts[item] || 0,
                }))
                .sort((a, b) => b.total - a.total);

            console.log(`Found ${frequencyData.length} unique ${n}-grams.`);
            return frequencyData;
        }


        // --- Statistics Calculation and Display ---
        function calculateAndDisplayStatistics(results, totalScripturesMatched, originalSearchTerm, useRegex) {
            console.log("Calculating statistics for", totalScripturesMatched, "results.");
            statsError.classList.add('hidden'); statsError.textContent = '';
            currentVolumeChartData = null;
            currentFrequencyData = {1: [], 2: [], 3: [], 4: []};

            if (!results || totalScripturesMatched === 0) {console.log("No results, clearing stats display."); clearStatisticsDisplay(); statsTabButton.disabled = true; return;}

            const shouldExcludeStopWords = excludeStopWordsCheckbox.checked;
            console.log("Stop word exclusion setting:", shouldExcludeStopWords);

            const volumeCounts = {};
            let totalWordsCounted = 0;
            const wordTotalCounts = {};
            const wordUniqueCounts = {};
            const wordFormsCounts = {};

            const calculateWordForms = !useRegex && originalSearchTerm && !originalSearchTerm.includes(' ') && !originalSearchTerm.match(/\s+(AND|OR)\s+/i);
            const normalizedSearchTermPrefix = calculateWordForms ? normalizeWord(originalSearchTerm) : null;
            console.log("Calculate Word Forms:", calculateWordForms, "Prefix:", normalizedSearchTermPrefix);

            results.forEach((verse) => {
                const volume = verse.volume_title || "Unknown Volume";
                volumeCounts[volume] = (volumeCounts[volume] || 0) + 1;

                const text = verse.scripture_text || "";
                const words = text.split(/\s+/);
                const uniqueWordsInThisVerse = new Set();

                words.forEach((rawWord) => {
                    const word = normalizeWord(rawWord);
                    if (word) {
                        const countThisWord = !shouldExcludeStopWords || !STOP_WORDS.has(word);

                        if (countThisWord) {
                            totalWordsCounted++;
                            wordTotalCounts[word] = (wordTotalCounts[word] || 0) + 1;
                            if (!uniqueWordsInThisVerse.has(word)) {
                                wordUniqueCounts[word] = (wordUniqueCounts[word] || 0) + 1;
                                uniqueWordsInThisVerse.add(word);
                            }
                        }

                        if (calculateWordForms && word.startsWith(normalizedSearchTermPrefix)) {
                            wordFormsCounts[word] = (wordFormsCounts[word] || 0) + 1;
                        }
                    }
                });
            });
            console.log("Total words counted (respecting stop words):", totalWordsCounted);
            console.log("Word Forms Counts:", wordFormsCounts);

            currentFrequencyData[1] = Object.keys(wordTotalCounts).map((word) => {
                const total = wordTotalCounts[word];
                const unique = wordUniqueCounts[word] || 0;
                const freqPerScripture = totalScripturesMatched > 0 ? total / totalScripturesMatched : 0;
                const freqPerWord = totalWordsCounted > 0 ? total / totalWordsCounted : 0;
                const coverage = totalScripturesMatched > 0 ? unique / totalScripturesMatched : 0;
                return {word: word, total: total, unique: unique, freqPerScripture: freqPerScripture, freqPerWord: freqPerWord, coverage: coverage};
            }).sort((a, b) => b.total - a.total);
            console.log("1-gram frequency data calculated:", currentFrequencyData[1].length, "unique words found.");

            currentFrequencyData[2] = calculateNGrams(results, 2, shouldExcludeStopWords);
            currentFrequencyData[3] = calculateNGrams(results, 3, shouldExcludeStopWords);
            currentFrequencyData[4] = calculateNGrams(results, 4, shouldExcludeStopWords);

            statsTotalCount.textContent = totalScripturesMatched;
            renderWordFormsBreakdown(wordFormsCounts, calculateWordForms);

            const volumeChartDataSource = HARDCODED_VOLUME_ORDER.map(volume => ({
                volume: volume,
                count: volumeCounts[volume] || 0
            })).filter(d => d.count > 0);
            Object.keys(volumeCounts).forEach(volume => {
                if (!HARDCODED_VOLUME_ORDER.includes(volume)) {
                    volumeChartDataSource.push({volume: volume, count: volumeCounts[volume]});
                }
            });
            currentVolumeChartData = volumeChartDataSource;
            console.log("Volume chart data stored:", currentVolumeChartData);

            console.log("Statistics calculation complete (chart/table rendering deferred).");
        }

        // --- D3 Volume Chart Rendering ---
        function renderVolumeChart(data) {
            if (!data || data.length === 0) {
                console.log("renderVolumeChart called with no data. Displaying placeholder.");
                statsVolumeChartContainer.innerHTML = '<p class="text-xs text-gray-500 italic text-center pt-4">No volume data to display.</p>';
                return;
            }
            console.log("Rendering volume chart with data:", data);
            statsVolumeChartContainer.innerHTML = '';

            setTimeout(() => {
                const containerWidth = statsVolumeChartContainer.clientWidth;
                if (!containerWidth) {
                    console.warn("Volume chart container has no width even after delay. Cannot render chart.");
                    statsVolumeChartContainer.innerHTML = '<p class="text-xs text-red-500 italic text-center pt-4">Error rendering chart (container width 0).</p>';
                    return;
                }
                console.log("Container width for chart:", containerWidth);

                const margin = {top: 10, right: 30, bottom: 20, left: 150};
                const barHeight = 25;
                const height = data.length * barHeight + margin.top + margin.bottom;
                const width = containerWidth - margin.left - margin.right;

                if (width <= 0) {
                    console.warn(`Calculated chart width is non-positive (${width}). Cannot render chart.`);
                    statsVolumeChartContainer.innerHTML = `<p class="text-xs text-red-500 italic text-center pt-4">Error rendering chart (calculated width ${width}).</p>`;
                    return;
                }

                const svg = d3.select("#statsVolumeChartContainer")
                    .append("svg")
                    .attr("width", containerWidth)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const yScale = d3.scaleBand()
                    .domain(data.map(d => d.volume))
                    .range([0, height - margin.top - margin.bottom])
                    .padding(0.2);

                const xScale = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.count) || 1])
                    .range([0, width]);

                const yAxis = d3.axisLeft(yScale).tickSizeOuter(0);
                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .selectAll(".tick text")
                    .call(wrapAxisText, margin.left - 10);

                const xAxis = d3.axisBottom(xScale).ticks(Math.min(5, d3.max(data, d => d.count))).tickFormat(d3.format("d"));
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
                    .call(xAxis);

                svg.selectAll(".bar")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("y", d => yScale(d.volume))
                    .attr("height", yScale.bandwidth())
                    .attr("x", 0)
                    .attr("width", 0)
                    .transition()
                    .duration(500)
                    .attr("width", d => Math.max(0, xScale(d.count)));

                svg.selectAll(".bar-label")
                    .data(data)
                    .enter()
                    .append("text")
                    .attr("class", "bar-label")
                    .attr("y", d => yScale(d.volume) + yScale.bandwidth() / 2)
                    .attr("x", d => Math.max(0, xScale(d.count)) + 5)
                    .text(d => d.count);

                console.log("Volume chart rendered.");
            }, 50);
        }
        function wrapAxisText(text, width) {
            text.each(function () {
                const text = d3.select(this);
                const words = text.text().split(/\s+/).reverse();
                let word;
                let line = [];
                let lineNumber = 0;
                const lineHeight = 1.1;
                const y = text.attr("y");
                const dy = parseFloat(text.attr("dy") || 0);
                let tspan = text.text(null).append("tspan").attr("x", -10).attr("y", y).attr("dy", dy + "em");
                while (word = words.pop()) {
                    line.push(word);
                    tspan.text(line.join(" "));
                    if (tspan.node().getComputedTextLength() > width && line.length > 1) {
                        line.pop();
                        tspan.text(line.join(" "));
                        line = [word];
                        tspan = text.append("tspan").attr("x", -10).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                    }
                }
            });
        }

        // --- Word Forms Breakdown Rendering ---
        function renderWordFormsBreakdown(formsData, wasSingleWordSearch) {
            console.log("Rendering word forms breakdown:", formsData);
            statsWordFormsList.innerHTML = '';

            if (!wasSingleWordSearch) {
                statsWordFormsPlaceholder.textContent = "Perform a non-regex, single-word search to see breakdown.";
                statsWordFormsPlaceholder.classList.remove('hidden');
                statsWordFormsList.classList.add('hidden');
                return;
            }

            const formsArray = Object.entries(formsData)
                .sort(([, countA], [, countB]) => countB - countA);

            if (formsArray.length === 0) {
                statsWordFormsPlaceholder.textContent = "No variations of the search term found in results.";
                statsWordFormsPlaceholder.classList.remove('hidden');
                statsWordFormsList.classList.add('hidden');
            } else {
                statsWordFormsPlaceholder.classList.add('hidden');
                statsWordFormsList.classList.remove('hidden');
                formsArray.forEach(([word, count]) => {
                    const li = document.createElement('li');
                    const wordSpan = document.createElement('span');
                    wordSpan.textContent = word;
                    const countSpan = document.createElement('span');
                    countSpan.textContent = count;
                    li.appendChild(wordSpan);
                    li.appendChild(countSpan);
                    statsWordFormsList.appendChild(li);
                });
            }
        }

        // --- Word Cloud Rendering ---
        function renderWordCloud(ngramSize) {
            console.log(`Rendering word cloud for ${ngramSize}-gram...`);
            const containerId = `wordCloudContainer${ngramSize}gram`;
            const cloudContainer = document.getElementById(containerId);
            if (!cloudContainer) {console.warn(`Word cloud container ${containerId} not found.`); return;}

            const statusElement = cloudContainer.querySelector('.wordCloudStatus');
            cloudContainer.innerHTML = '';
            if (statusElement) {
                statusElement.textContent = "Generating word cloud...";
                cloudContainer.appendChild(statusElement);
            } else {
                const newStatus = document.createElement('p');
                newStatus.className = 'wordCloudStatus text-center text-gray-500 p-4';
                newStatus.textContent = "Generating word cloud...";
                cloudContainer.appendChild(newStatus);
            }

            const frequencyData = currentFrequencyData[ngramSize] || [];
            const dataKey = ngramSize === 1 ? 'word' : 'phrase';
            let baseSizeMultiplier = 5;
            if (ngramSize === 2) baseSizeMultiplier = 3.5;
            else if (ngramSize === 3) baseSizeMultiplier = 3;
            else if (ngramSize === 4) baseSizeMultiplier = 2.5;

            const wordData = frequencyData.slice(0, WORD_CLOUD_LIMIT).map(d => ({
                text: d[dataKey],
                size: Math.sqrt(d.total) * baseSizeMultiplier
            }));

            const typeName = ngramSize === 1 ? 'word' :
                ngramSize === 2 ? 'phrase' :
                    ngramSize === 3 ? 'triplet' : 'quartet';

            if (wordData.length === 0) {
                console.log(`No data for ${ngramSize}-gram word cloud.`);
                const currentStatus = cloudContainer.querySelector('.wordCloudStatus');
                if (currentStatus) currentStatus.textContent = `Not enough data to generate ${typeName} cloud.`;
                return;
            }

            try {
                const containerWidth = cloudContainer.clientWidth > 0 ? cloudContainer.clientWidth : 300;
                const containerHeight = 250;
                wordCloudLayout = d3.layout.cloud()
                    .size([containerWidth, containerHeight])
                    .words(wordData)
                    .padding(ngramSize === 1 ? 5 : ngramSize === 2 ? 3 : (ngramSize === 3 ? 2 : 1.5))
                    .rotate(() => (ngramSize === 1 && Math.random() > 0.7 ? 90 : 0))
                    .font("sans-serif")
                    .fontSize(d => d.size)
                    .on("end", (words) => drawWordCloud(words, ngramSize, containerId, containerWidth, containerHeight));
                wordCloudLayout.start();
            } catch (error) {
                console.error(`Error initializing D3 cloud layout for ${ngramSize}-gram:`, error);
                const currentStatus = cloudContainer.querySelector('.wordCloudStatus');
                if (currentStatus) currentStatus.textContent = `Error generating ${typeName} cloud layout.`;
            }
        }
        function drawWordCloud(words, ngramSize, containerId, width, height) {
            console.log(`Drawing ${ngramSize}-gram word cloud SVG in ${containerId}...`);
            const cloudContainer = document.getElementById(containerId);
            if (!cloudContainer) {console.warn(`Word cloud container ${containerId} not found during draw.`); return;}
            cloudContainer.innerHTML = '';
            const typeName = ngramSize === 1 ? 'word' :
                ngramSize === 2 ? 'phrase' :
                    ngramSize === 3 ? 'triplet' : 'quartet';
            try {
                const svg = d3.select(`#${containerId}`).append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

                svg.selectAll("text")
                    .data(words)
                    .enter().append("text")
                    .style("font-size", d => d.size + "px")
                    .style("font-family", "sans-serif")
                    .style("fill", (d, i) => d3.schemeCategory10[i % 10])
                    .attr("text-anchor", "middle")
                    .attr("transform", d => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")")
                    .text(d => d.text)
                    .attr("class", "word-cloud-word")
                    .on("click", ngramSize === 1 ? (event, d) => {
                        console.log(`${ngramSize}-gram clicked:`, d.text);
                        searchInput.value = d.text;
                        regexSearchCheckbox.checked = false;
                        performSearch();
                    } : null);

                console.log(`${ngramSize}-gram word cloud drawn.`);
            } catch (error) {
                console.error(`Error drawing D3 ${ngramSize}-gram word cloud:`, error);
                cloudContainer.innerHTML = `<p class="wordCloudStatus text-center text-red-600 p-4">Error drawing ${typeName} cloud.</p>`;
            }
        }

        // --- Frequency Table Rendering (Generic for N-grams) ---
        function renderFrequencyTable() {
            console.log(`Rendering frequency table for ${currentNgramSize}-gram.`);
            const data = currentFrequencyData[currentNgramSize] || [];
            let tableBody, headers, colspan, defaultSortCol, defaultSortDir, dataKey;

            if (currentNgramSize === 1) {
                tableBody = statsWordTableBody; headers = statsWordTableHeaders; colspan = 6; defaultSortCol = 'total'; defaultSortDir = 'desc'; dataKey = 'word';
            } else if (currentNgramSize === 2) {
                tableBody = statsBigramTableBody; headers = statsBigramTableHeaders; colspan = 3; defaultSortCol = 'total'; defaultSortDir = 'desc'; dataKey = 'phrase';
            } else if (currentNgramSize === 3) {
                tableBody = statsTrigramTableBody; headers = statsTrigramTableHeaders; colspan = 3; defaultSortCol = 'total'; defaultSortDir = 'desc'; dataKey = 'phrase';
            } else if (currentNgramSize === 4) {
                tableBody = statsQuatgramTableBody; headers = statsQuatgramTableHeaders; colspan = 3; defaultSortCol = 'total'; defaultSortDir = 'desc'; dataKey = 'phrase';
            } else {
                console.error("Unsupported N-gram size for table rendering:", currentNgramSize); return;
            }

            tableBody.innerHTML = "";

            if (!headers || headers.length === 0 || !Array.from(headers).some(th => th.dataset.sort === currentSortColumn)) {
                currentSortColumn = defaultSortCol;
                currentSortDirection = defaultSortDir;
                console.log(`Resetting sort for ${currentNgramSize}-gram to ${currentSortColumn} ${currentSortDirection}`);
            }

            data.sort((a, b) => {
                let compareA = a[currentSortColumn];
                let compareB = b[currentSortColumn];
                if (currentSortColumn === "word" || (currentSortColumn === "phrase" && currentNgramSize > 1)) {
                    compareA = (compareA || "").toLowerCase();
                    compareB = (compareB || "").toLowerCase();
                } else {
                    compareA = Number(compareA || 0);
                    compareB = Number(compareB || 0);
                }
                if (compareA < compareB) return currentSortDirection === "asc" ? -1 : 1;
                if (compareA > compareB) return currentSortDirection === "asc" ? 1 : -1;
                return 0;
            });

            if (headers) {
                headers.forEach((th) => {
                    th.classList.remove("sorted-asc", "sorted-desc");
                    if (th.dataset.sort === currentSortColumn) {
                        th.classList.add(currentSortDirection === "asc" ? "sorted-asc" : "sorted-desc");
                    }
                });
            }

            const dataToDisplay = data.slice(0, 100);
            const typeName = currentNgramSize === 1 ? 'word' :
                currentNgramSize === 2 ? '2-gram' :
                    currentNgramSize === 3 ? '3-gram' : '4-gram';
            if (dataToDisplay.length === 0) {
                console.log(`No ${typeName} data to display.`);
                tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-gray-500 py-4">No ${typeName} frequency data to display.</td></tr>`;
            } else {
                console.log(`Populating ${typeName} table with ${dataToDisplay.length} rows.`);
                dataToDisplay.forEach((item) => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = item[dataKey];
                    row.insertCell().textContent = item.total;
                    row.insertCell().textContent = item.unique;
                    if (currentNgramSize === 1) {
                        row.insertCell().textContent = formatStat(item.freqPerScripture, 3);
                        row.insertCell().textContent = formatPercentage(item.freqPerWord, 2);
                        row.insertCell().textContent = formatPercentage(item.coverage, 1);
                    }
                });
            }
        }

        // --- Sorting Logic (Handles multiple tables) ---
        function handleSort(column, tableType) {
            console.log(`Handling sort for column: ${column} in table: ${tableType}`);
            const targetNgramSize = parseInt(tableType.replace('gram', ''), 10);

            if (targetNgramSize !== currentNgramSize) {
                console.warn(`Sort triggered for inactive table (${tableType}). Ignoring.`);
                return;
            }

            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === "asc" ? "desc" : "asc";
            } else {
                currentSortColumn = column;
                if (['freqPerScripture', 'freqPerWord', 'coverage', 'total', 'unique'].includes(column)) {
                    currentSortDirection = 'desc';
                } else {
                    currentSortDirection = 'asc';
                }
            }
            renderFrequencyTable();
        }
        document.querySelectorAll('.stats-table th[data-sort]').forEach((th) => {
            let tableType = '1gram';
            if (th.closest('#statsBigramTable')) {tableType = '2gram';}
            else if (th.closest('#statsTrigramTable')) {tableType = '3gram';}
            else if (th.closest('#statsQuatgramTable')) {tableType = '4gram';}
            th.addEventListener("click", () => handleSort(th.dataset.sort, tableType));
        });

        // --- Clear Statistics Display ---
        function clearStatisticsDisplay() {
            console.log("Clearing statistics display.");
            statsTotalCount.textContent = "0";
            statsVolumeChartContainer.innerHTML = '<p class="text-xs text-gray-500 italic text-center pt-4">Perform a search to generate volume chart.</p>';
            currentVolumeChartData = null;
            statsWordFormsList.innerHTML = '';
            statsWordFormsPlaceholder.textContent = "Perform a non-regex, single-word search to see breakdown.";
            statsWordFormsPlaceholder.classList.remove('hidden');
            statsWordFormsList.classList.add('hidden');

            statsWordTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4">Perform a search to see statistics.</td></tr>`;
            statsBigramTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500 py-4">Perform a search to see 2-gram statistics.</td></tr>`;
            if (statsTrigramTableBody) {
                statsTrigramTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500 py-4">Perform a search to see 3-gram statistics.</td></tr>`;
            }
            if (statsQuatgramTableBody) {
                statsQuatgramTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500 py-4">Perform a search to see 4-gram statistics.</td></tr>`;
            }

            document.querySelectorAll('.wordCloudContainer').forEach(container => {
                const size = container.id.match(/(\d+)gram/)?.[1];
                const type = size === '1' ? 'word' : size === '2' ? 'phrase' : (size === '3' ? 'triplet' : 'quartet');
                container.innerHTML = `<p class="wordCloudStatus text-center text-gray-500 p-4">Perform a search to generate ${type} cloud.</p>`;
            });

            currentFrequencyData = {1: [], 2: [], 3: [], 4: []};
            document.querySelectorAll('.stats-table th[data-sort]').forEach((th) => {th.classList.remove("sorted-asc", "sorted-desc");});
            statsError.classList.add('hidden'); statsError.textContent = '';
            currentNgramSize = 1;
            ngramTabButtons.forEach(btn => btn.classList.remove('active'));
            ngramTabContainer.querySelector('[data-ngram-tab="1gram"]').classList.add('active');
            ngramTabContents.forEach(content => content.classList.remove('active'));
            document.getElementById('1gramContent')?.classList.add('active');
        }

        // --- Event Delegation for Copy and Add to Journal Buttons ---
        document.body.addEventListener("click", async (event) => {
            const copyButton = event.target.closest('.copy-button');
            const addToJournalButton = event.target.closest('.add-to-journal-button');

            // Use the globally defined modal elements:
            // noteModal, modalScriptureTextEl, modalVerseTitleEl, noteTextarea,
            // saveNoteButton, cancelNoteButton are already defined globally.
            // You might need a specific close button for THIS modal if the class '.modal-close-button' is too generic
            // or ensure the global 'modalCloseButton' is the one from 'noteModal'.
            // Let's assume the global 'modalCloseButton' is the one for the 'noteModal'
            // OR, if you changed the HTML for noteModal's close button to have an ID:
            const noteModalSpecificCloseButton = document.getElementById('noteModalCloseButton'); // If you add this ID

            if (copyButton && (resultsContainer.contains(copyButton) || contextDrawerContent.contains(copyButton))) {
                console.log("Copy button clicked:", copyButton);
                const textToCopy = unescape(copyButton.dataset.copy);
                const copyButtonText = copyButton.innerHTML;
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    console.log("Text copied to clipboard:", textToCopy);
                    showButtonFeedback(copyButton, '<span class="text-green-600">✓ Copied!</span>');
                } catch (err) {
                    console.error("Failed to copy text: ", err);
                    // copyButton.textContent = "Error"; // This replaces the SVG
                    copyButton.innerHTML = '<span class="text-red-600">Error</span>'; // Keep SVG structure in mind
                    setTimeout(() => {copyButton.innerHTML = copyButtonText;}, 1500);
                }
            } else if (addToJournalButton && (resultsContainer.contains(addToJournalButton) || contextDrawerContent.contains(addToJournalButton))) {
                console.log("Add to Journal button identified:", addToJournalButton);

                let noteTextareaKeydownHandlerInstance; // To store the function for later removal
                let overlayClickHandlerInstance;      // To store the overlay click handler

                const verseTitle = unescape(addToJournalButton.dataset.verseTitle);
                const scriptureText = unescape(addToJournalButton.dataset.scriptureText);

                if (modalScriptureTextEl) modalScriptureTextEl.textContent = scriptureText;
                if (modalVerseTitleEl) modalVerseTitleEl.textContent = verseTitle;

                showModal(); // Calls the new global showModal

                const cleanupModalSpecificListeners = () => {
                    if (noteTextarea && noteTextareaKeydownHandlerInstance) {
                        noteTextarea.removeEventListener('keydown', noteTextareaKeydownHandlerInstance);
                        console.log("Removed Shift+Enter listener from noteTextarea.");
                    }
                    if (noteModal && overlayClickHandlerInstance) {
                        noteModal.removeEventListener('click', overlayClickHandlerInstance);
                        console.log("Removed overlay click listener from noteModal.");
                    }
                };

                const handleSaveNote = () => {
                    console.log(`handleSaveNote: started. scriptureText:${scriptureText} ${verseTitle}`);
                    const userNote = noteTextarea.value.trim();
                    let appendedNote = `> ${scriptureText} (${verseTitle})`;
                    if (userNote) {
                        appendedNote = `${userNote}\n${appendedNote}`;
                    }
                    if (journalEditor.value) { // add space if there's already a note
                        appendedNote = `\n\n${appendedNote}`;
                    }
                    console.log(`appendedNote: ${appendedNote}`)
                    journalEditor.value += appendedNote;

                    updateJournalPreview();
                    journalEditor.scrollTop = journalEditor.scrollHeight;
                    journalEditor.focus();

                    showButtonFeedback(addToJournalButton, '<span class="text-green-600">✓ Added!</span>');
                    console.log(`Added to journal: ${verseTitle} with note: "${userNote}"`);
                    hideModal();
                    cleanupModalSpecificListeners();
                };

                const handleCancelNote = () => {
                    console.log('handleCancelNote: started');
                    hideModal();
                    cleanupModalSpecificListeners();
                };

                // Define the Shift+Enter handler
                noteTextareaKeydownHandlerInstance = (e) => {
                    if (e.key === 'Enter' && e.shiftKey) {
                        e.preventDefault(); // Important: Prevent new line in textarea
                        console.log("Shift+Enter detected in noteTextarea, attempting to save.");
                        handleSaveNote();
                    }
                };
                // Add the keydown listener to the textarea
                if (noteTextarea) {
                    noteTextarea.addEventListener('keydown', noteTextareaKeydownHandlerInstance);
                    console.log("Added Shift+Enter listener to noteTextarea.");
                }

                const handleOverlayClick = (e) => {
                    if (e.target === noteModal) {
                        console.log('Overlay click detected for noteModal');
                        handleCancelNote();
                    }
                };

                // Ensure event listeners are added to the correct global button elements
                if (saveNoteButton) saveNoteButton.addEventListener('click', handleSaveNote, {once: true});
                if (cancelNoteButton) cancelNoteButton.addEventListener('click', handleCancelNote, {once: true});

                // Use the close button specific to noteModal if you gave it an ID,
                // otherwise, the global `modalCloseButton` should be the one from `noteModal`.
                const actualNoteModalCloseButton = noteModal.querySelector('.modal-close-button'); // Get it fresh
                if (actualNoteModalCloseButton) {
                    actualNoteModalCloseButton.addEventListener('click', handleCancelNote, {once: true});
                }

                // For overlay click, you might not want {once: true} if the modal can be re-opened
                // and the listener needs to be active again.
                // It's better to add it here and ensure it's removed in handleSaveNote/handleCancelNote if needed.
                // However, since hideModal() is called which doesn't remove this specific listener,
                // and the main listener here is on document.body, this could lead to multiple overlay listeners
                // if not careful.
                // Simplest for now: if the modal is hidden, this specific click won't match e.target === noteModal.
                // A more robust way for overlay is to have ONE listener on noteModal that checks e.target.
                noteModal.addEventListener('click', handleOverlayClick); // Add it
                // And ensure it's removed:
                const cleanupOverlay = () => noteModal.removeEventListener('click', handleOverlayClick);
                if (saveNoteButton) saveNoteButton.addEventListener('click', cleanupOverlay, {once: true});
                if (cancelNoteButton) cancelNoteButton.addEventListener('click', cleanupOverlay, {once: true});
                if (actualNoteModalCloseButton) actualNoteModalCloseButton.addEventListener('click', cleanupOverlay, {once: true});


            }
        });
        // Optional: Close modal with Escape key
        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                if (searchHelpModalOverlay.classList.contains("active")) closeModal(searchHelpModalOverlay);
                if (statsHelpModalOverlay.classList.contains("active")) closeModal(statsHelpModalOverlay);
                if (stopWordsModalOverlay.classList.contains("active")) closeModal(stopWordsModalOverlay);
                if (contextDrawerOverlay.classList.contains("active")) closeModal(contextDrawerOverlay);

                // Check for the noteModal
                if (noteModal && noteModal.classList.contains("active")) {
                    console.log("Escape key: Hiding noteModal");
                    hideModal(); // Calls the global hideModal
                    // If hideModal doesn't clean up specific listeners from save/cancel buttons
                    // added within the addToJournalButton click, and those buttons were NOT {once:true},
                    // you might need to manually trigger their cleanup here.
                    // But since we are using {once:true}, this should be fine.
                }
            }
        });
        // --- Populate Stop Words Modal ---
        function populateStopWordsModal() {
            stopWordsListDisplay.innerHTML = '';
            const sortedStopWords = Array.from(STOP_WORDS).sort();
            sortedStopWords.forEach(word => {
                const li = document.createElement('li');
                li.textContent = word;
                stopWordsListDisplay.appendChild(li);
            });
        }

        // --- Journal Chat Panel Functionality ---
        const journalButton = document.getElementById("journalButton");
        const closeJournalButton = document.getElementById("closeJournalButton");
        const journalSection = document.getElementById("journalSection");

        function toggleJournalPanel() {
            const isHidden = journalSection.classList.contains("translate-y-full");
            if (isHidden) {
                journalSection.classList.remove("translate-y-full");
                journalButton.classList.add("hidden");
            } else {
                journalSection.classList.add("translate-y-full");
                journalButton.classList.remove("hidden");
            }
        }

        journalButton.addEventListener("click", toggleJournalPanel);
        closeJournalButton.addEventListener("click", toggleJournalPanel);

        function updateJournalPreview() {
            const markdownText = journalEditor.value;
            if (markdownText.trim() === "") {
                journalPreview.innerHTML = '<p class="text-gray-400 italic">Your formatted journal notes will appear here.</p>';
            } else {
                journalPreview.innerHTML = marked.parse(markdownText);
            }
        }

        const editorToggle = document.getElementById("editorToggle");
        const previewToggle = document.getElementById("previewToggle");

        function showEditor() {
            journalEditor.classList.remove("hidden");
            journalPreview.classList.add("hidden");
            editorToggle.classList.remove("bg-gray-200", "text-gray-700");
            editorToggle.classList.add("bg-blue-600", "text-white");
            previewToggle.classList.remove("bg-blue-600", "text-white");
            previewToggle.classList.add("bg-gray-200", "text-gray-700");
        }

        function showPreview() {
            journalEditor.classList.add("hidden");
            journalPreview.classList.remove("hidden");
            previewToggle.classList.remove("bg-gray-200", "text-gray-700");
            previewToggle.classList.add("bg-blue-600", "text-white");
            editorToggle.classList.remove("bg-blue-600", "text-white");
            editorToggle.classList.add("bg-gray-200", "text-gray-700");
            updateJournalPreview();
        }

        editorToggle.addEventListener("click", showEditor);
        previewToggle.addEventListener("click", showPreview);
        journalEditor.addEventListener("input", updateJournalPreview);

        downloadJournalButton.addEventListener("click", () => {
            const content = journalEditor.value;
            const blob = new Blob([content], {type: "text/markdown;charset=utf-8"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "scripture_journal.md";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log("Journal downloaded.");
        });



        copyJournalButton.addEventListener("click", async () => {
            const content = journalEditor.value;
            if (!content) {
                alert("Journal is empty. Nothing to copy.");
                return;
            }
            try {
                await navigator.clipboard.writeText(content);
                showButtonFeedback(copyJournalButton, '<span>✓ Copied!</span>')
                console.log("Journal content copied.");
            } catch (err) {
                console.error("Failed to copy journal: ", err);
                alert("Failed to copy journal. See console for details.");
            }
        });

        clearJournalButton.addEventListener("click", () => {
            if (journalEditor.value.trim() === "") {
                alert("Journal is already empty.");
                return;
            }
            if (confirm("Are you sure you want to clear the entire journal? This action cannot be undone.")) {
                journalEditor.value = "";
                updateJournalPreview();
                console.log("Journal cleared.");
            }
        });


        // --- Initial Setup ---
        document.addEventListener("DOMContentLoaded", function () {
            console.log("DOM Loaded. Setting up event listeners.");
            searchButton.addEventListener("click", performSearch);
            searchInput.addEventListener("keypress", (e) => {if (e.key === "Enter") performSearch();});
            verseTitleFilterInput.addEventListener("keypress", (e) => {if (e.key === "Enter") performSearch();});

            shuffleResultsCheckbox.checked = true;
            console.log("Default: Shuffle Results enabled.");

            columnsByVolumeCheckbox.checked = true;
            console.log("Default: Columns by Volume enabled.");
            resultsContainer.className = "results-flex-container";

            columnsByVolumeCheckbox.addEventListener("change", () => {
                console.log("Columns by Volume checkbox changed.");
                const hasResults = scriptureCache.currentResults && scriptureCache.currentResults.length > 0;
                if (hasResults) {
                    console.log("Triggering re-display due to column change with existing results.");
                    displayResults(scriptureCache.currentResults, searchInput.value.trim(), caseSensitiveCheckbox.checked, columnsByVolumeCheckbox.checked);
                } else {
                    console.log("Column view changed, but no results currently displayed. Only updating class.");
                    resultsContainer.className = columnsByVolumeCheckbox.checked ? "results-flex-container" : "results-grid-container";
                }
            });

            console.log("Triggering initial data load.");
            fetchScriptureData().catch((err) => {console.error("Initial data load failed:", err);});
            toggleAdvancedSearchArea(false);
            toggleAdvancedSearchButton.style.display = 'inline-flex';
            toggleAdvancedSearchLink.style.display = 'none';
            clearStatisticsDisplay();
            populateStopWordsModal();
            updateJournalPreview(); // Initial call to set placeholder if empty
        });
    </script>
</body>

</html>
