<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scripture Study</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jasondavies/d3-cloud@1.2.7/build/d3.layout.cloud.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-4 text-gray-800">
            Scripture Study
        </h1>
        <p class="text-center">Search, find, journal, write, repeat.</p>
        <div id="loadingIndicator" class="hidden text-center py-8 max-w-4xl mx-auto border border-gray-300 rounded-lg">
            <p class="mt-2 text-gray-600">Loading 40,000 scriptures for faster search! Thanks for waiting ~5 seconds...
            </p>
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-600"></div>
        </div>

        <div id="searchSection" class="mb-8 max-w-4xl mx-auto">
            <div class="flex gap-2 items-start">
                <div class="flex-grow">
                    <label for="searchInput" class="sr-only">Search Text</label>
                    <input type="text" id="searchInput" placeholder="Enter phrase, keywords (AND/OR), or regex..."
                        class="w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg bg-white placeholder-gray-400" />
                    <div id="searchInputError" class="input-error-message"></div>
                </div>
                <button id="searchButton"
                    class="px-6 py-4 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors whitespace-nowrap">seek,</button>
                <button id="toggleAdvancedButton" title="Toggle Filters" class="p-4 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 011.45.12l.773.774c.39.389.44 1.002.12 1.45l-.527.737c-.25.35-.272.806-.107 1.204.165.397.505.71.93.781l.893.149c.543.09.94.56.94 1.109v1.094c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.143.854.107 1.204l.527.738c.32.447.269 1.06-.12 1.45l-.774.773a1.125 1.125 0 01-1.449.12l-.738-.527a1.125 1.125 0 00-1.204-.107c-.397.165-.71.505-.781.93l-.149.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.148-.894a1.125 1.125 0 00-.781-.93 1.125 1.125 0 00-1.204.107l-.738.527c-.447.32-1.058.269-1.449-.12l-.773-.774a1.125 1.125 0 01-.12-1.45l.527-.737c.25-.35.273-.806.108-1.204-.165-.397-.505-.71-.93-.781l-.894-.149a1.125 1.125 0 01-.94-1.11v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.142-.854-.108-1.204l-.527-.738a1.125 1.125 0 01.12-1.45l.773-.773a1.125 1.125 0 011.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71-.505.781-.93l.149-.894z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="sr-only">Toggle Filters</span>
                </button>
            </div>
            <div id="seekMessage" class="text-xs text-gray-500 mt-2 h-4"></div>
            <div id="advancedSearchArea" class="advanced-search-collapsible">
                <div class="flex-grow space-y-4">
                    <h3 class='text-lg font-semibold mb-3 text-gray-700 text-center'>Filters & View Options</h3>
                </div>
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-grow space-y-4">
                        <h4 class="text-lg font-semibold mb-4 text-gray-700">Filters</h4>
                        <div>
                            <label for="verseTitleFilterInput"
                                class="block text-sm font-medium text-gray-700 mb-1">Filter by Verse Title
                                (Regex)</label>
                            <input type="text" id="verseTitleFilterInput" placeholder="e.g., ^John 3:1[6-7]$ or Alma 5"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                            <div id="verseTitleFilterError" class="input-error-message"></div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Come Follow Me</label>
                            <div class="flex items-center mb-2">
                                <input type="checkbox" id="comeFollowMeFilterCheckbox"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-2" />
                                <label for="comeFollowMeFilterCheckbox"
                                    class="text-sm font-medium text-gray-900 cursor-pointer">Filter by Come Follow Me Reading</label>
                            </div>
                            <select id="comeFollowMeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm disabled:bg-gray-100 disabled:text-gray-500" disabled>
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="border-t pt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Volume</label>
                            <div class="flex items-center mb-2"><input type="checkbox" id="allVolumesCheckbox"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-2"
                                    checked /><label for="allVolumesCheckbox"
                                    class="text-sm font-medium text-gray-900 cursor-pointer">All Volumes</label>
                            </div>
                            <div id="volumeCheckboxes"
                                class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-2"></div>
                        </div>
                    </div>
                    <div class="md:w-1/3 border border-gray-200 p-4 rounded-lg bg-gray-50">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Advanced Options</h4>
                        <div class="space-y-3">
                            <div class="flex gap-2 items-center"><input type="checkbox" id="regexSearch"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" /><label
                                    for="regexSearch" class="text-sm text-gray-700 cursor-pointer">Search using
                                    regex</label></div>
                            <div class="flex gap-2 items-center"><input type="checkbox" id="caseSensitive"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" /><label
                                    for="caseSensitive" class="text-sm text-gray-700 cursor-pointer">Case
                                    Sensitive</label></div>
                            <div class="flex gap-2 items-center"><input type="checkbox" id="columnsByVolume"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" /><label
                                    for="columnsByVolume" class="text-sm text-gray-700 cursor-pointer">Show
                                    Volume
                                    Columns</label></div>
                            <div class="flex gap-2 items-center"><input type="checkbox" id="shuffleResults"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" /><label
                                    for="shuffleResults" class="text-sm text-gray-700 cursor-pointer">Shuffle
                                    Results</label></div>
                            <div class="flex gap-2 items-center"><input type="checkbox" id="compactView"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" /><label
                                    for="compactView" class="text-sm text-gray-700 cursor-pointer">Compact View</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fallbackMessage"></div>

        <div class="mb-4 max-w-4xl mx-auto">
            <div class="flex justify-between items-center">
                <h2 id="resultsHeading" class="text-xl font-semibold text-gray-800"><span
                        id="resultsHeadingText">Results</span></h2>
            </div>
            <p id="searchStatus" class="text-sm text-gray-500 mt-1"></p>
        </div>

        <div class="tab-container max-w-4xl mx-auto">
            <button id="scripturesTabButton" class="tab-button active" data-tab="scriptures">Scriptures (<span
                    id="scripturesTabCount">0</span>)</button>
            <button id="statsTabButton" class="tab-button" data-tab="statistics" disabled>Statistics</button>
        </div>

        <div class="tab-content-container max-w-full mx-auto">
            <div id="scripturesContent" class="tab-content active">
                <div id="noResults" class="hidden bg-gray-50 p-8 rounded-lg text-center max-w-4xl mx-auto">
                    <p class="text-gray-600"></p>
                </div>
                <div id="resultsContainer"></div>
            </div>

            <div id="statisticsContent" class="tab-content">
                <div id="statsDisplayArea" class="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">Search Statistics</h3>
                        <button id="explainStatsButton"
                            class="text-sm text-blue-600 hover:text-blue-800 underline focus:outline-none">
                            <span class="info-icon mr-1">i</span>Explain Statistics
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mb-6">
                        <div>
                            <div id="statsSummary" class="mb-4 space-y-1">
                                <p><strong>Total Unique Scriptures Matched:</strong> <span id="statsTotalCount">0</span>
                                </p>
                            </div>
                            <div id="statsWordFormsContainer">
                                <h5 class="text-sm font-semibold mb-1 text-gray-600">Word Forms Breakdown:</h5>
                                <p class="no-forms text-xs text-gray-500 italic">Perform a non-regex,
                                    single-word search
                                    to see breakdown.</p>
                                <ul class="word-form-list"></ul>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-md font-semibold mb-2 text-gray-600">Matches per Volume:</h4>
                            <div id="statsVolumeChartContainer">
                                <p class="text-xs text-gray-500 italic text-center pt-4">Perform a search to
                                    generate
                                    volume chart.</p>
                            </div>
                        </div>
                    </div>

                    <div id="statsNgramSection">
                        <h4 class="text-md font-semibold mb-2 text-gray-600 border-t pt-4">N-gram Analysis (Top
                            100)
                        </h4>
                        <p class="text-xs text-gray-500 mb-2">Analyze common words or phrases. Click headers to
                            sort
                            table.</p>
                        <div class="flex items-center space-x-4 mb-2 text-sm">
                            <div class="flex items-center">
                                <input type="checkbox" id="excludeStopWordsCheckbox"
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mr-1"
                                    checked />
                                <label for="excludeStopWordsCheckbox" class="text-gray-700 cursor-pointer">Exclude Stop
                                    Words</label>
                            </div>
                            <button id="showStopWordsButton"
                                class="text-blue-600 hover:text-blue-800 underline text-xs focus:outline-none">
                                Show Stop Words
                            </button>
                        </div>
                        <div id="ngramTabContainer" class="ngram-tab-container">
                            <button class="ngram-tab-button active" data-ngram-tab="1gram">1-gram
                                (Words)</button>
                            <button class="ngram-tab-button" data-ngram-tab="2gram">2-gram (Pairs)</button>
                            <button class="ngram-tab-button" data-ngram-tab="3gram">3-gram (Triplets)</button>
                            <button class="ngram-tab-button" data-ngram-tab="4gram">4-gram (Quartets)</button>
                        </div>
                        <div id="ngramTabContentContainer">
                            <div id="1gramContent" class="ngram-tab-content active">
                                <div class="mb-4">
                                    <h5 class="text-sm font-semibold mb-1 text-gray-600">Word Cloud</h5>
                                    <div id="wordCloudContainer1gram" class="wordCloudContainer">
                                        <p class="wordCloudStatus text-center text-gray-500 p-4">Perform a
                                            search to
                                            generate word cloud.</p>
                                    </div>
                                </div>
                                <h5 class="text-sm font-semibold mb-1 text-gray-600">Frequency Table</h5>
                                <div class="overflow-x-auto">
                                    <table id="statsWordTable" class="stats-table">
                                        <thead>
                                            <tr>
                                                <th data-sort="word">Word <span class="sort-arrow"></span></th>
                                                <th data-sort="total">Total Count <span class="sort-arrow"></span></th>
                                                <th data-sort="unique">Unique Count <span class="sort-arrow"></span>
                                                </th>
                                                <th data-sort="freqPerScripture">Freq/Scripture <span
                                                        class="sort-arrow"></span></th>
                                                <th data-sort="freqPerWord">Freq/Word <span class="sort-arrow"></span>
                                                </th>
                                                <th data-sort="coverage">Coverage <span class="sort-arrow"></span></th>
                                            </tr>
                                        </thead>
                                        <tbody id="statsWordTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center text-gray-500 py-4">Perform a
                                                    search
                                                    to see statistics.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="2gramContent" class="ngram-tab-content">
                                <div class="mb-4">
                                    <h5 class="text-sm font-semibold mb-1 text-gray-600">Phrase Cloud</h5>
                                    <div id="wordCloudContainer2gram" class="wordCloudContainer">
                                        <p class="wordCloudStatus text-center text-gray-500 p-4">Perform a
                                            search to
                                            generate phrase cloud.</p>
                                    </div>
                                </div>
                                <h5 class="text-sm font-semibold mb-1 text-gray-600">Frequency Table</h5>
                                <div class="overflow-x-auto">
                                    <table id="statsBigramTable" class="stats-table">
                                        <thead>
                                            <tr>
                                                <th data-sort="phrase">Phrase (2-gram) <span class="sort-arrow"></span>
                                                </th>
                                                <th data-sort="total">Total Count <span class="sort-arrow"></span></th>
                                                <th data-sort="unique">Unique Count <span class="sort-arrow"></span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="statsBigramTableBody">
                                            <tr>
                                                <td colspan="3" class="text-center text-gray-500 py-4">Perform a
                                                    search
                                                    to see 2-gram statistics.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="3gramContent" class="ngram-tab-content">
                                <div class="mb-4">
                                    <h5 class="text-sm font-semibold mb-1 text-gray-600">Triplet Cloud</h5>
                                    <div id="wordCloudContainer3gram" class="wordCloudContainer">
                                        <p class="wordCloudStatus text-center text-gray-500 p-4">Perform a
                                            search to
                                            generate triplet cloud.</p>
                                    </div>
                                </div>
                                <h5 class="text-sm font-semibold mb-1 text-gray-600">Frequency Table</h5>
                                <div class="overflow-x-auto">
                                    <table id="statsTrigramTable" class="stats-table">
                                        <thead>
                                            <tr>
                                                <th data-sort="phrase">Triplet (3-gram) <span class="sort-arrow"></span>
                                                </th>
                                                <th data-sort="total">Total Count <span class="sort-arrow"></span></th>
                                                <th data-sort="unique">Unique Count <span class="sort-arrow"></span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="statsTrigramTableBody">
                                            <tr>
                                                <td colspan="3" class="text-center text-gray-500 py-4">Perform a
                                                    search
                                                    to see 3-gram statistics.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="4gramContent" class="ngram-tab-content">
                                <div class="mb-4">
                                    <h5 class="text-sm font-semibold mb-1 text-gray-600">Quartet Cloud</h5>
                                    <div id="wordCloudContainer4gram" class="wordCloudContainer">
                                        <p class="wordCloudStatus text-center text-gray-500 p-4">Perform a
                                            search to
                                            generate quartet cloud.</p>
                                    </div>
                                </div>
                                <h5 class="text-sm font-semibold mb-1 text-gray-600">Frequency Table</h5>
                                <div class="overflow-x-auto">
                                    <table id="statsQuatgramTable" class="stats-table">
                                        <thead>
                                            <tr>
                                                <th data-sort="phrase">Quartet (4-gram) <span class="sort-arrow"></span>
                                                </th>
                                                <th data-sort="total">Total Count <span class="sort-arrow"></span></th>
                                                <th data-sort="unique">Unique Count <span class="sort-arrow"></span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="statsQuatgramTableBody">
                                            <tr>
                                                <td colspan="3" class="text-center text-gray-500 py-4">Perform a
                                                    search
                                                    to see 4-gram statistics.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="statsError" class="text-red-600 text-sm mt-4 hidden"></div>
                </div>
            </div>
        </div>

        <!-- Floating Search History Button -->
        <button id="searchHistoryButton"
            class="fixed bottom-4 left-4 bg-indigo-600 text-white rounded-full p-4 shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-transform hover:scale-110 z-50">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
        </button>

        <!-- Temporary Floating Help Button -->
        <button id="howToSearchButton" title="How to Search"
            class="fixed top-4 right-4 bg-gray-600 text-white rounded-full p-3 shadow-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-opacity duration-1000 transition-transform hover:scale-110 z-50">
            <span class="text-lg font-semibold">?</span>
        </button>

        <!-- Search History Panel -->
        <div id="searchHistorySection"
            class="fixed bottom-0 left-0 w-full md:w-1/3 h-[50vh] bg-white shadow-lg rounded-t-lg transform translate-y-full transition-transform duration-300 ease-in-out z-40 overflow-hidden">
            <div class="flex flex-col h-full">
                <div class="flex justify-between items-center px-4 py-3 border-b">
                    <h2 class="text-xl font-semibold text-gray-800">Search History</h2>
                    <button id="closeSearchHistoryButton" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                </div>
                <div class="flex-grow overflow-y-auto p-4">
                    <div id="searchHistoryList" class="space-y-3">
                        <!-- Search history items will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Note Button -->
        <button id="journalButton"
            class="fixed bottom-4 right-4 bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform hover:scale-110 z-50">
            <svg id="penIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
            </svg>
            </svg>
        </button>

        <!-- Journal Chat Panel -->
        <div id="journalSection"
            class="fixed bottom-0 right-0 w-full md:w-1/2 h-[70vh] bg-white shadow-lg rounded-t-lg transform translate-y-full transition-transform duration-300 ease-in-out z-40 overflow-hidden">
            <div class="flex flex-col h-full overflow-hidden">
                <div class="flex justify-between items-center px-4 py-3 border-b">
                    <div class="flex items-center space-x-4">
                        <h2 class="text-xl font-semibold text-gray-800">Notes</h2>
                        <div class="flex space-x-2">
                            <button id="editorToggle"
                                class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                                <svg id="penIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                                </svg>
                            </button>
                            <button id="previewToggle"
                                class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm">
                                <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                            <button id="copyJournalButton"
                                class="px-3 py-1.5 bg-indigo-600 text-white text-sm font-medium rounded hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline align-text-bottom">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332
                                        0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0
                                        1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128
                                        1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5
                                        19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" />
                                </svg>
                            </button>
                            <button id="downloadJournalButton"
                                class="px-3 py-1.5 bg-green-600 text-white text-sm font-medium rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline align-text-bottom">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                </svg>
                            </button>
                            <button id="clearJournalButton"
                                class="px-3 py-1.5 bg-red-500 text-white text-sm font-medium rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-4 h-4 align-text-bottom">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.576 0c1.256-.623 2.693-.936 4.136-.936s2.88.313 4.136.936m-1.022-.165L15.23 2.283A2.25 2.25 0 0013.487 1.5H10.52a2.25 2.25 0 00-1.742.783l-.897 1.524" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button id="closeJournalButton" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                </div>

                <div class="flex flex-col flex-grow overflow-hidden p-4">
                    <div class="flex-grow flex flex-col min-h-0 relative">
                        <textarea id="journalEditor"
                            class="absolute inset-0 p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent overflow-y-auto"
                            style="resize: none; height: 100%;"
                            placeholder="⚠️Remember, remember: this is a temporary notepad, which will disappear if you refresh your browser!⚠️ Start writing your journal entry here... Scripture references will be added automatically when you click the '+' on a scripture card. This journal uses 'markdown' syntax, which Google Docs supports. You can click the 'Preview' button to see your formatted journal entry, or copy this into a Google Doc to see it formatted."></textarea>
                        <div id="journalPreview"
                            class="absolute inset-0 p-3 border border-gray-200 rounded-md bg-gray-50 overflow-y-auto hidden">
                            <p class="text-gray-400 italic">Your formatted journal notes will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Instructions/README  -->
        <div id="searchHelpModalOverlay" class="modal-overlay">
            <div class="modal-box"><button id="searchHelpModalCloseButton" class="modal-close-button">&times;</button>
                <div class="modal-content">
                    <h3>What is this?</h3>
                    <p>What scripture search tool do you know of that can let you find all scriptures with both
                        "faith"
                        and "Jesus" in them? Or the verse first mentions "faith" and then "hope", in that order?
                        This
                        app solves those powerful search needs.</p>
                    <h3>How to Search</h3>
                    <p>You can search for exact phrases, use keywords with AND/OR, or enable full regular
                        expressions.
                    </p>
                    <h4>Keyword Search (AND/OR)</h4>
                    <p>If the "Search using regex" box is <strong>not</strong> checked:</p>
                    <ul>
                        <li><strong>AND Search:</strong> Type words separated by <code> AND </code> (e.g.,
                            <code>faith AND hope</code>). Finds verses with <strong>both</strong> words, in any
                            order.
                            Auto-converted to regex: <code>faith.*?hope|hope.*?faith</code>.
                        </li>
                        <li><strong>OR Search:</strong> Type words separated by <code> OR </code> (e.g.,
                            <code>love OR charity</code>). Finds verses with <strong>either</strong> word.
                            Auto-converted to regex: <code>love|charity</code>.
                        </li>
                        <li><strong>Note:</strong> <code>AND</code> takes precedence over <code>OR</code> if
                            both are
                            used without regex mode. Use regex mode for complex logic.</li>
                    </ul>
                    <h4>Exact Phrase Search</h4>
                    <p>If you don't use <code>AND</code>/<code>OR</code> and regex is off, it searches for the
                        exact
                        word sequence.</p>
                    <h4>Regular Expression (Regex) Search</h4>
                    <p>Check "Search using regex" to use regex patterns.</p>
                    <ul>
                        <li>Example: <code>^And it came to pass</code> (Starts with...).</li>
                        <li>Example: <code>Nephi|Lehi</code> (Contains either).</li>
                        <li>Example: <code>baptis(m|ed)</code> (Contains "baptism" or "baptised").</li>
                    </ul>
                    <p>Consider the "Case Sensitive" option.</p>
                    <h4>Verse Title Filter</h4>
                    <p>Always uses case-insensitive regex.</p>
                    <ul>
                        <li>Example: <code>^Moroni 10:</code> (All verses in Moroni 10).</li>
                        <li>Example: <code>1 Nephi 3:7$</code> (Exactly 1 Nephi 3:7).</li>
                        <li>Example: <code>(John|Luke) \d+:1$</code> (First verse of any chapter in John or
                            Luke).</li>
                    </ul>
                    <h4>Volume Filters</h4>
                    <p>Use checkboxes to select which volumes to include.</p>
                </div>
            </div>
        </div>

        <div id="statsHelpModalOverlay" class="modal-overlay">
            <div class="modal-box">
                <button id="statsHelpModalCloseButton" class="modal-close-button">&times;</button>
                <div class="modal-content">
                    <h3>Understanding the Statistics</h3>
                    <p>These statistics provide insights into the words and phrases found within the scriptures
                        matching
                        your search criteria.</p>
                    <h4>Overall Summary</h4>
                    <dl>
                        <dt>Total Unique Scriptures Matched</dt>
                        <dd>The total number of distinct scripture verses returned by your current search
                            filters and
                            criteria.</dd>
                    </dl>
                    <h4>Matches per Volume Chart</h4>
                    <p>A horizontal bar chart showing the number of matched scriptures belonging to each volume.
                    </p>
                    <h4>Word Forms Breakdown</h4>
                    <p>If you performed a non-regex search for a single word (e.g., "faith"), this section shows
                        the
                        counts for different words found in the results that start with your normalized search
                        term
                        (e.g., "faith", "faithful", "faithfulness"). This helps clarify how the total match
                        count
                        relates to specific word variations.</p>
                    <dl>
                        <dt>Word Form: Count</dt>
                        <dd>Shows the total number of times each specific word form appears across all matched
                            scriptures.</dd>
                    </dl>
                    <h4>N-gram Analysis Section</h4>
                    <p>This section shows the most common words (1-gram), pairs (2-gram), triplets (3-gram), or
                        quartets
                        (4-gram) found in the matched scriptures. Each tab provides a word/phrase cloud
                        visualization
                        and a frequency table.</p>
                    <p>Use the "Exclude Stop Words" checkbox to control whether common words (like "the", "a",
                        "is") are
                        included in the analysis. Excluding them often highlights more meaningful terms,
                        especially for
                        1-grams. Including them preserves the exact phrasing for 2-grams, 3-grams and 4-grams.
                    </p>
                    <h5>Word/Phrase Cloud</h5>
                    <p>A visual representation of the most frequent items (words, pairs, triplets, or quartets)
                        for the
                        selected N-gram size. Larger items appear more frequently. Clicking an item will search
                        for it
                        (only works well for single words).</p>
                    <h5>Frequency Tables</h5>
                    <p>These tables show detailed counts for individual words (1-gram), pairs (2-gram), triplets
                        (3-gram), or quartets (4-gram).</p>
                    <dl>
                        <dt>Word / Phrase / Triplet / Quartet</dt>
                        <dd>The specific normalized word (1-gram), sequence of two words (2-gram), sequence of
                            three
                            words (3-gram), or sequence of four words (4-gram) being analyzed.</dd>
                        <dt>Total Count</dt>
                        <dd>The absolute total number of times this <strong>specific item</strong> appears
                            across ALL
                            matched scriptures. An item can appear multiple times in a single scripture.</dd>
                        <dt>Unique Count</dt>
                        <dd>The number of unique scriptures (out of the 'Total Unique Scriptures Matched') that
                            contain
                            this <strong>specific item</strong> at least once.</dd>
                        <dt>Freq/Scripture (1-gram only)</dt>
                        <dd>Average number of times this specific word appears per matched scripture. Calculated
                            as:
                            <code>Word's Total Count / Total Unique Scriptures Matched</code>.
                        </dd>
                        <dt>Freq/Word (1-gram only)</dt>
                        <dd>The proportion of this specific word relative to all words counted across all
                            matched
                            scriptures (respecting the "Exclude Stop Words" setting). Calculated as:
                            <code>Word's Total Count / Total Words Counted</code>.
                        </dd>
                        <dt>Coverage (1-gram only)</dt>
                        <dd>The percentage of matched scriptures that contain this specific word at least once.
                            Calculated as: <code>Word's Unique Count / Total Unique Scriptures Matched</code>.
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <div id="stopWordsModalOverlay" class="modal-overlay">
            <div class="modal-box">
                <button id="stopWordsModalCloseButton" class="modal-close-button">&times;</button>
                <div class="modal-content">
                    <h3>Stop Words List</h3>
                    <p>These common words are excluded from N-gram analysis when the "Exclude Stop Words"
                        checkbox is
                        checked. This list helps focus the analysis on more significant terms.</p>
                    <ul id="stopWordsListDisplay" class="stop-words-list mt-4">
                        <li>Loading...</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="contextDrawerOverlay" class="modal-overlay">
            <div class="modal-box context-drawer-box">
                <button id="contextDrawerCloseButton" class="modal-close-button">&times;</button>
                <h3 id="contextDrawerTitle" class="text-xl font-semibold mb-4 text-gray-700">Chapter Context
                </h3>
                <div id="contextDrawerContent" class="space-y-2">
                    <p class="text-center text-gray-500">Loading context...</p>
                </div>
            </div>
        </div>

        <!-- Note button when you click "add to journal"  -->
        <div id="noteModal" class="modal-overlay">
            <div class="modal-box"> <button class="modal-close-button">&times;</button>
                <h3 class="text-xl font-semibold mb-4">Add a Note to your Journal</h3>
                <textarea id="noteTextarea" class="w-full p-2 border border-gray-300 rounded-md mb-4"
                    placeholder="Enter your note here..."></textarea>
                <p class="mb-4"><strong><span id="modalVerseTitle"></span></strong>&nbsp;<span
                        id="modalScriptureText"></span></p>
                <div class="flex justify-center">
                    <button id="saveNoteButton"
                        class="px-4 py-2 bg-blue-600 text-white text-center rounded-md hover:bg-blue-700">Add to
                        Journal</button>
                </div>
                <p class='text-center text-gray-500 text-xs mt-4'>Tip: shift+enter on Desktop</p>
            </div>
        </div>

        <div id="compactActionModal" class="modal-overlay">
            <div class="modal-box w-full max-w-md"> <button id="compactActionModalCloseButton"
                    class="modal-close-button">&times;</button>
                <h3 id="compactActionModalTitle" class="text-lg font-semibold mb-1 text-gray-800">Actions</h3>
                <p id="compactActionModalVerseRef" class="text-sm text-gray-500 mb-4">[Verse Reference]</p>
                <div class="space-y-2">
                    <button id="compactActionCopyButton"
                        class="w-full flex items-center space-x-2 p-3 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" />
                        </svg>
                        <span>Copy Scripture</span>
                    </button>
                    <button id="compactActionAddToJournalButton"
                        class="w-full flex items-center space-x-2 p-3 bg-green-500 text-white rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        <span>Add to Journal</span>
                    </button>
                    <button id="compactActionGoogleSearchButton"
                        class="w-full flex items-center space-x-2 p-3 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                        </svg>
                        <span>Search on Google</span>
                    </button>
                    <a id="compactActionChurchSiteLink" href="#" target="_blank" rel="noopener noreferrer"
                        class="w-full flex items-center space-x-2 p-3 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
                        </svg>
                        <span>Search on Church Website</span>
                    </a>
                </div>
            </div>
        </div>

    </div> <!-- End of .container -->
    <script src="script.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(console.error);
            });
        }
    </script>
</body>

</html>
